# í™˜ì ë“±ë¡ ê°œì„  êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-12-06
**ë²„ì „**: 1.0
**ìƒíƒœ**: âœ… Backend êµ¬í˜„ ì™„ë£Œ, Frontend êµ¬í˜„ ëŒ€ê¸°

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [êµ¬í˜„ ë‚´ìš©](#êµ¬í˜„-ë‚´ìš©)
3. [ë°±ì—”ë“œ êµ¬í˜„ ìƒì„¸](#ë°±ì—”ë“œ-êµ¬í˜„-ìƒì„¸)
4. [API ì—”ë“œí¬ì¸íŠ¸](#api-ì—”ë“œí¬ì¸íŠ¸)
5. [ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ì‚¬í•­](#ë°ì´í„°ë² ì´ìŠ¤-ë³€ê²½ì‚¬í•­)
6. [ë³´ì•ˆ êµ¬í˜„](#ë³´ì•ˆ-êµ¬í˜„)
7. [í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](#í…ŒìŠ¤íŠ¸-ê°€ì´ë“œ)
8. [ë‹¤ìŒ ë‹¨ê³„](#ë‹¤ìŒ-ë‹¨ê³„)

---

## ê°œìš”

### ë³€ê²½ ì „ ë¬¸ì œì 
- í™˜ìê°€ ì§ì ‘ íšŒì›ê°€ì… ì‹œ ë‹´ë‹¹ ì˜ì‚¬ ì—†ì´ Patient ë ˆì½”ë“œ ìƒì„±
- ê°„í˜¸ì‚¬ì˜ í™˜ì ê²€ì¦ ë° ë“±ë¡ í”„ë¡œì„¸ìŠ¤ ë¶€ì¬
- í™˜ì ì •ë³´ ìˆ˜ì§‘ ì²´ê³„ ë¯¸í¡

### ê°œì„ ëœ íë¦„
1. **ê°„í˜¸ì‚¬**: ë‚´ì› í™˜ì ì •ë³´ë¥¼ ì‹œìŠ¤í…œì— ë¨¼ì € ë“±ë¡
   - ì´ë¦„, ì£¼ë¯¼ë²ˆí˜¸, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ ìˆ˜ì§‘
   - ë³‘ì› ë“±ë¡ë²ˆí˜¸(medical_record_number) ìë™ ë°œê¸‰
   - ë‹´ë‹¹ ì˜ì‚¬ ì§€ì •
   - í™˜ì ID(pid) ìë™ ë°œê¸‰

2. **í™˜ì**: ëª¨ë°”ì¼ ì•± ë¡œê·¸ì¸ (íšŒì›ê°€ì… ë¶ˆí•„ìš”)
   - ì „í™”ë²ˆí˜¸(í•˜ì´í”ˆ ì œê±°)ê°€ ë¡œê·¸ì¸ ID
   - ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: `testpass123`
   - SMS ì¸ì¦ ë¡œê·¸ì¸ ì§€ì›
   - ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìˆ˜

3. **ì‹œìŠ¤í…œ**: ìë™ ë§¤ì¹­
   - ì „í™”ë²ˆí˜¸ë¡œ Patient ë ˆì½”ë“œ ê²€ìƒ‰
   - Userì™€ Patient ìë™ ì—°ê²°
   - ë‹´ë‹¹ ì˜ì‚¬ ìë™ í• ë‹¹

---

## êµ¬í˜„ ë‚´ìš©

### âœ… ì™„ë£Œëœ í•­ëª©

#### 1. ë°±ì—”ë“œ ëª¨ë¸ ë³€ê²½
- [x] `UserProfile` ëª¨ë¸ì— `is_first_login` í•„ë“œ ì¶”ê°€
- [x] `Patient` ëª¨ë¸ì— `ssn_encrypted` í•„ë“œ ì¶”ê°€ (BinaryField)
- [x] `Patient` ëª¨ë¸ì— `medical_record_number` í•„ë“œ ì¶”ê°€ (unique)

#### 2. ë°±ì—”ë“œ ìœ í‹¸ë¦¬í‹°
- [x] ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì•”í˜¸í™”/ë³µí˜¸í™” í•¨ìˆ˜ (`encrypt_ssn`, `decrypt_ssn`)
- [x] SMS ì½”ë“œ ìƒì„± í•¨ìˆ˜ (`generate_sms_code`)
- [x] SMS ì „ì†¡ í•¨ìˆ˜ (`send_sms`)
- [x] ì „í™”ë²ˆí˜¸ ì •ê·œí™” í•¨ìˆ˜ (`normalize_phone_number`)
- [x] ì§„ë£Œê¸°ë¡ë²ˆí˜¸ ìƒì„± í•¨ìˆ˜ (`generate_medical_record_number`)
- [x] í™˜ì ID ìƒì„± í•¨ìˆ˜ (`generate_patient_pid`)

#### 3. ë°±ì—”ë“œ Serializers
- [x] `NursePatientRegistrationSerializer` - ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ìš©

#### 4. ë°±ì—”ë“œ Views
- [x] `NursePatientViewSet` - ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ ViewSet
- [x] `sms_request_code` - SMS ì¸ì¦ ì½”ë“œ ìš”ì²­ API
- [x] `sms_verify_and_login` - SMS ì¸ì¦ ë° ë¡œê·¸ì¸ API
- [x] `change_password` - ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ `is_first_login` í”Œë˜ê·¸ ì—…ë°ì´íŠ¸

#### 5. ë°±ì—”ë“œ Permissions
- [x] `IsNurseOrAdmin` - ê°„í˜¸ì‚¬ ë˜ëŠ” ê´€ë¦¬ì ê¶Œí•œ ì²´í¬

#### 6. ë°±ì—”ë“œ URL ë¼ìš°íŒ…
- [x] `/api/v1/users/nurse/register_patient/` - í™˜ì ë“±ë¡
- [x] `/api/v1/users/sms/request/` - SMS ì½”ë“œ ìš”ì²­
- [x] `/api/v1/users/sms/verify/` - SMS ë¡œê·¸ì¸

#### 7. ì„¤ì • ë³€ê²½
- [x] `settings.py`ì— `ENCRYPTION_KEY` ì¶”ê°€
- [x] `.env.example`ì— `ENCRYPTION_KEY` ì˜ˆì‹œ ì¶”ê°€

#### 8. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
- [x] `0004_userprofile_is_first_login.py` ìƒì„±
- [x] `0002_patient_medical_record_number_patient_ssn_encrypted.py` ìƒì„±

### â³ ë¯¸ì™„ë£Œ í•­ëª© (í”„ë¡ íŠ¸ì—”ë“œ)

#### React (ê°„í˜¸ì‚¬ìš© ê´€ë¦¬ í˜ì´ì§€)
- [ ] í™˜ì ë“±ë¡ í˜ì´ì§€ êµ¬í˜„
- [ ] ë‹´ë‹¹ ì˜ì‚¬ ì„ íƒ ë“œë¡­ë‹¤ìš´
- [ ] í™˜ì ì •ë³´ ì…ë ¥ í¼
- [ ] ë“±ë¡ ì™„ë£Œ í›„ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ

#### Flutter (í™˜ììš© ëª¨ë°”ì¼ ì•±)
- [ ] ë¡œê·¸ì¸ í™”ë©´ì—ì„œ íšŒì›ê°€ì… ë²„íŠ¼ ì œê±°
- [ ] SMS ë¡œê·¸ì¸ ì˜µì…˜ ì¶”ê°€
- [ ] SMS ì¸ì¦ ì½”ë“œ ì…ë ¥ í™”ë©´
- [ ] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ (ì²« ë¡œê·¸ì¸ ê°•ì œ)
- [ ] `is_first_login` ì²´í¬ ë¡œì§

---

## ë°±ì—”ë“œ êµ¬í˜„ ìƒì„¸

### 1. ëª¨ë¸ ë³€ê²½

#### UserProfile (apps/users/models.py)
```python
is_first_login = models.BooleanField(
    default=True,
    verbose_name="ìµœì´ˆ ë¡œê·¸ì¸ ì—¬ë¶€",
    help_text="Trueë©´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìˆ˜"
)
```

#### Patient (apps/emr/models.py)
```python
ssn_encrypted = models.BinaryField(
    null=True,
    blank=True,
    verbose_name="ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (ì•”í˜¸í™”)",
    help_text="Fernet ì•”í˜¸í™”ëœ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸"
)

medical_record_number = models.CharField(
    max_length=50,
    unique=True,
    null=True,
    blank=True,
    verbose_name="ì§„ë£Œê¸°ë¡ë²ˆí˜¸",
    help_text="ê°„í˜¸ì‚¬ ë“±ë¡ ì‹œ ë°œê¸‰ë˜ëŠ” ë³‘ì› ë“±ë¡ë²ˆí˜¸ (ì˜ˆ: MR-20250101-0001)"
)
```

### 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (apps/users/utils.py)

#### ì•”í˜¸í™” ê´€ë ¨
- `get_encryption_key()`: settingsì—ì„œ ì•”í˜¸í™” í‚¤ ê°€ì ¸ì˜¤ê¸°
- `encrypt_ssn(ssn: str) -> bytes`: ì£¼ë¯¼ë²ˆí˜¸ ì•”í˜¸í™”
- `decrypt_ssn(encrypted_ssn: bytes) -> str`: ì£¼ë¯¼ë²ˆí˜¸ ë³µí˜¸í™”

#### SMS ê´€ë ¨
- `generate_sms_code(length: int = 6) -> str`: 6ìë¦¬ ì¸ì¦ ì½”ë“œ ìƒì„±
- `send_sms(phone_number: str, message: str) -> bool`: SMS ì „ì†¡ (í”Œë ˆì´ìŠ¤í™€ë”)

#### ë²ˆí˜¸ ìƒì„±
- `normalize_phone_number(phone: str) -> str`: ì „í™”ë²ˆí˜¸ ì •ê·œí™” (í•˜ì´í”ˆ ì œê±°)
- `generate_medical_record_number() -> str`: MR-YYYYMMDD-NNNN í˜•ì‹
- `generate_patient_pid() -> str`: PT-YYYYMMDD-NNNN í˜•ì‹

### 3. Serializer (apps/users/serializers.py)

#### NursePatientRegistrationSerializer
**ì…ë ¥ í•„ë“œ**:
- `first_name`: ì´ë¦„ (required)
- `last_name`: ì„± (required)
- `ssn`: ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (required)
- `phone`: ì „í™”ë²ˆí˜¸ (required)
- `date_of_birth`: ìƒë…„ì›”ì¼ (required)
- `gender`: ì„±ë³„ M/F/O (required)
- `doctor_id`: ë‹´ë‹¹ ì˜ì‚¬ ID (required)
- `address`: ì£¼ì†Œ (optional)
- `email`: ì´ë©”ì¼ (optional)
- `emergency_contact`: ë¹„ìƒ ì—°ë½ì²˜ (optional)
- `insurance_id`: ê±´ê°•ë³´í—˜ ë²ˆí˜¸ (optional)

**ê²€ì¦ ë¡œì§**:
- ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬
- ì˜ì‚¬ ID ì¡´ì¬ ë° DOCTOR ì—­í•  í™•ì¸

**ìƒì„± ë¡œì§**:
1. ì „í™”ë²ˆí˜¸ë¥¼ ì •ê·œí™”í•˜ì—¬ username ìƒì„±
2. User ìƒì„± (password: `testpass123`)
3. UserProfile ìƒì„± (`is_first_login=True`)
4. ì£¼ë¯¼ë²ˆí˜¸ ì•”í˜¸í™”
5. ì§„ë£Œê¸°ë¡ë²ˆí˜¸ ë° í™˜ì ID ìƒì„±
6. Patient ìƒì„± (ë‹´ë‹¹ ì˜ì‚¬ í• ë‹¹)

### 4. ViewSet (apps/users/views.py)

#### NursePatientViewSet
- **ê¶Œí•œ**: `IsNurseOrAdmin`
- **ë©”ì„œë“œ**: `register_patient` (POST)
- **ê¸°ëŠ¥**:
  - ê°„í˜¸ì‚¬ê°€ í™˜ì ì •ë³´ ì…ë ¥
  - User, UserProfile, Patient ìë™ ìƒì„±
  - SMS ì•Œë¦¼ ì „ì†¡ (ë“±ë¡ ì™„ë£Œ ì•ˆë‚´)
  - ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°˜í™˜

#### SMS Login Views
**sms_request_code**:
- ì „í™”ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
- 6ìë¦¬ ì¸ì¦ ì½”ë“œ ìƒì„±
- Redis cacheì— 5ë¶„ê°„ ì €ì¥
- SMS ì „ì†¡

**sms_verify_and_login**:
- ì¸ì¦ ì½”ë“œ ê²€ì¦
- JWT í† í° ìƒì„± ë° ë°˜í™˜
- `is_first_login` í”Œë˜ê·¸ í¬í•¨

### 5. URL ë¼ìš°íŒ… (apps/users/urls.py)
```python
urlpatterns = [
    # ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ë“¤...
    path('sms/request/', views.sms_request_code, name='sms_request_code'),
    path('sms/verify/', views.sms_verify_and_login, name='sms_verify_and_login'),
    # ...
]

router.register(r'nurse', views.NursePatientViewSet, basename='nurse')
```

---

## API ì—”ë“œí¬ì¸íŠ¸

### 1. ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡
**Endpoint**: `POST /api/v1/users/nurse/register_patient/`
**ê¶Œí•œ**: Nurse ë˜ëŠ” Admin
**Request Body**:
```json
{
  "first_name": "í™",
  "last_name": "ê¸¸ë™",
  "ssn": "900101-1234567",
  "phone": "010-1234-5678",
  "date_of_birth": "1990-01-01",
  "gender": "M",
  "doctor_id": 5,
  "address": "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
  "email": "hong@example.com",
  "emergency_contact": "010-9876-5432",
  "insurance_id": "123456789"
}
```

**Response** (201 Created):
```json
{
  "message": "í™˜ì ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
  "patient_id": 42,
  "pid": "PT-20250106-0001",
  "medical_record_number": "MR-20250106-0001",
  "username": "01012345678",
  "temp_password": "testpass123"
}
```

### 2. SMS ì¸ì¦ ì½”ë“œ ìš”ì²­
**Endpoint**: `POST /api/v1/users/sms/request/`
**ê¶Œí•œ**: AllowAny
**Request Body**:
```json
{
  "phone": "010-1234-5678"
}
```

**Response** (200 OK):
```json
{
  "message": "SMS ì¸ì¦ ì½”ë“œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "expires_in": 300
}
```

### 3. SMS ì¸ì¦ ë° ë¡œê·¸ì¸
**Endpoint**: `POST /api/v1/users/sms/verify/`
**ê¶Œí•œ**: AllowAny
**Request Body**:
```json
{
  "phone": "010-1234-5678",
  "code": "123456"
}
```

**Response** (200 OK):
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 42,
    "username": "01012345678",
    "email": "hong@example.com",
    "role": "PATIENT"
  },
  "is_first_login": true
}
```

### 4. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
**Endpoint**: `POST /api/v1/users/change_password/`
**ê¶Œí•œ**: Authenticated
**Request Body**:
```json
{
  "old_password": "testpass123",
  "new_password": "MyNewPassword123!",
  "new_password_confirm": "MyNewPassword123!"
}
```

**Response** (200 OK):
```json
{
  "message": "Password changed successfully"
}
```

**ì°¸ê³ **: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ ì‹œ `is_first_login` í”Œë˜ê·¸ê°€ ìë™ìœ¼ë¡œ `False`ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.

---

## ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ì‚¬í•­

### Migration íŒŒì¼

#### 1. `apps/users/migrations/0004_userprofile_is_first_login.py`
- `UserProfile` í…Œì´ë¸”ì— `is_first_login` ì»¬ëŸ¼ ì¶”ê°€
- ê¸°ë³¸ê°’: `True`

#### 2. `apps/emr/migrations/0002_patient_medical_record_number_patient_ssn_encrypted.py`
- `Patient` í…Œì´ë¸”ì— `ssn_encrypted` ì»¬ëŸ¼ ì¶”ê°€ (BinaryField)
- `Patient` í…Œì´ë¸”ì— `medical_record_number` ì»¬ëŸ¼ ì¶”ê°€ (unique)

### ì ìš© ë°©ë²•
```bash
cd backend/django_main
python manage.py migrate users 0004
python manage.py migrate emr 0002
```

**ì£¼ì˜**: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. `.env` íŒŒì¼ì—ì„œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:
- `DB_HOST`
- `DB_NAME`
- `DB_USER`
- `DB_PASSWORD`

---

## ë³´ì•ˆ êµ¬í˜„

### 1. ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì•”í˜¸í™”
- **ì•Œê³ ë¦¬ì¦˜**: Fernet (ëŒ€ì¹­í‚¤ ì•”í˜¸í™”)
- **í‚¤ ì €ì¥**: `settings.ENCRYPTION_KEY` (í™˜ê²½ ë³€ìˆ˜)
- **ì €ì¥ í˜•íƒœ**: BinaryField (ì•”í˜¸í™”ëœ ë°”ì´íŠ¸)

**í‚¤ ìƒì„± ë°©ë²•**:
```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

### 2. SMS ì¸ì¦ ì½”ë“œ
- **ê¸¸ì´**: 6ìë¦¬ ìˆ«ì
- **ìœ íš¨ ì‹œê°„**: 5ë¶„ (300ì´ˆ)
- **ì €ì¥ì†Œ**: Redis cache (`sms_code:{normalized_phone}`)
- **ì¬ì‚¬ìš© ë°©ì§€**: ê²€ì¦ ì„±ê³µ ì‹œ ì¦‰ì‹œ ì‚­ì œ

### 3. ì„ì‹œ ë¹„ë°€ë²ˆí˜¸
- **ê¸°ë³¸ê°’**: `testpass123`
- **ë³´ì•ˆ ì¡°ì¹˜**:
  - `is_first_login=True` í”Œë˜ê·¸ë¡œ ê°•ì œ ë³€ê²½ ìœ ë„
  - Django ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì ìš© (ë³€ê²½ ì‹œ)
  - SMSë¡œ í™˜ìì—ê²Œ ì•ˆë‚´

### 4. ê¶Œí•œ ì œì–´
- **í™˜ì ë“±ë¡**: `IsNurseOrAdmin` ê¶Œí•œ í•„ìš”
- **SMS ë¡œê·¸ì¸**: ê³µê°œ API (AllowAny)
- **ë¹„ë°€ë²ˆí˜¸ ë³€ê²½**: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥

---

## í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### 1. ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ í…ŒìŠ¤íŠ¸

#### Prerequisites
- ê°„í˜¸ì‚¬ ë˜ëŠ” ê´€ë¦¬ì ê³„ì • í•„ìš”
- ì˜ì‚¬ ê³„ì • ì¡´ì¬ (doctor_idë¡œ ì‚¬ìš©)

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
```bash
# 1. ê°„í˜¸ì‚¬ ë¡œê·¸ì¸
POST /api/v1/users/login/
{
  "username": "nurse01",
  "password": "nurse_password"
}
# => access token ë°›ê¸°

# 2. í™˜ì ë“±ë¡
POST /api/v1/users/nurse/register_patient/
Authorization: Bearer {access_token}
{
  "first_name": "í…ŒìŠ¤íŠ¸",
  "last_name": "í™˜ì",
  "ssn": "900101-1234567",
  "phone": "010-1111-2222",
  "date_of_birth": "1990-01-01",
  "gender": "M",
  "doctor_id": 3
}
# => ë“±ë¡ ì„±ê³µ, temp_password í™•ì¸

# 3. í™˜ì ë¡œê·¸ì¸ (ì „í™”ë²ˆí˜¸)
POST /api/v1/users/login/
{
  "username": "01011112222",  # í•˜ì´í”ˆ ì œê±°
  "password": "testpass123"
}
# => JWT í† í° ë° is_first_login: true í™•ì¸

# 4. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
POST /api/v1/users/change_password/
Authorization: Bearer {patient_access_token}
{
  "old_password": "testpass123",
  "new_password": "NewPassword123!",
  "new_password_confirm": "NewPassword123!"
}
# => ì„±ê³µ í›„ is_first_loginì´ falseë¡œ ë³€ê²½ë¨
```

### 2. SMS ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

```bash
# 1. SMS ì½”ë“œ ìš”ì²­
POST /api/v1/users/sms/request/
{
  "phone": "010-1111-2222"
}
# => ë¡œê·¸ì—ì„œ ì¸ì¦ ì½”ë“œ í™•ì¸ (ê°œë°œ í™˜ê²½)

# 2. SMS ì¸ì¦ ë° ë¡œê·¸ì¸
POST /api/v1/users/sms/verify/
{
  "phone": "010-1111-2222",
  "code": "123456"  # ë¡œê·¸ì—ì„œ í™•ì¸í•œ ì½”ë“œ
}
# => JWT í† í° ë° is_first_login í”Œë˜ê·¸ í™•ì¸
```

### 3. ì•”í˜¸í™” í…ŒìŠ¤íŠ¸

```python
# Django shell
python manage.py shell

from apps.users.utils import encrypt_ssn, decrypt_ssn

# ì•”í˜¸í™”
encrypted = encrypt_ssn("900101-1234567")
print(encrypted)  # b'gAAA...'

# ë³µí˜¸í™”
decrypted = decrypt_ssn(encrypted)
print(decrypted)  # "900101-1234567"
```

### 4. ë²ˆí˜¸ ìƒì„± í…ŒìŠ¤íŠ¸

```python
from apps.users.utils import generate_medical_record_number, generate_patient_pid

# ì§„ë£Œê¸°ë¡ë²ˆí˜¸ ìƒì„±
mrn = generate_medical_record_number()
print(mrn)  # MR-20250106-0001

# í™˜ì ID ìƒì„±
pid = generate_patient_pid()
print(pid)  # PT-20250106-0001
```

---

## ë‹¤ìŒ ë‹¨ê³„

### 1. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)

#### React (ê°„í˜¸ì‚¬ìš© ê´€ë¦¬ í˜ì´ì§€)
**íŒŒì¼**: `frontend/react_web/src/pages/admin/PatientRegistration.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- í™˜ì ì •ë³´ ì…ë ¥ í¼
  - ì´ë¦„, ì„±, ì£¼ë¯¼ë²ˆí˜¸
  - ì „í™”ë²ˆí˜¸, ì£¼ì†Œ
  - ìƒë…„ì›”ì¼, ì„±ë³„
  - ì´ë©”ì¼, ë¹„ìƒì—°ë½ì²˜ (ì„ íƒ)
  - ê±´ê°•ë³´í—˜ ë²ˆí˜¸ (ì„ íƒ)
- ë‹´ë‹¹ ì˜ì‚¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ (GET `/api/v1/users/?role=DOCTOR`)
- ë“±ë¡ ì™„ë£Œ í›„:
  - ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ (ë³µì‚¬ ê°€ëŠ¥)
  - í™˜ì ID, ì§„ë£Œê¸°ë¡ë²ˆí˜¸ í‘œì‹œ
  - í”„ë¦°íŠ¸ ê¸°ëŠ¥ (í™˜ì ì•ˆë‚´ë¬¸)

#### Flutter (í™˜ììš© ëª¨ë°”ì¼ ì•±)

**1. ë¡œê·¸ì¸ í™”ë©´ ìˆ˜ì •**
**íŒŒì¼**: `frontend/flutter_app/lib/presentation/pages/auth/login_screen.dart`

**ë³€ê²½ì‚¬í•­**:
- íšŒì›ê°€ì… ë²„íŠ¼ ì œê±°
- "SMS ë¡œê·¸ì¸" ë²„íŠ¼ ì¶”ê°€
- ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œ (í•˜ì´í”ˆ ìë™ ì‚½ì…)

**2. SMS ë¡œê·¸ì¸ í™”ë©´**
**íŒŒì¼**: `frontend/flutter_app/lib/presentation/pages/auth/sms_login_screen.dart`

**êµ¬í˜„ ë‚´ìš©**:
- ì „í™”ë²ˆí˜¸ ì…ë ¥ â†’ "ì¸ì¦ ì½”ë“œ ìš”ì²­" ë²„íŠ¼
- ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ (5ë¶„)
- 6ìë¦¬ ì½”ë“œ ì…ë ¥ í•„ë“œ
- "í™•ì¸" ë²„íŠ¼ â†’ ë¡œê·¸ì¸
- ì—ëŸ¬ ì²˜ë¦¬ (ë§Œë£Œ, ë¶ˆì¼ì¹˜ ë“±)

**3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´**
**íŒŒì¼**: `frontend/flutter_app/lib/presentation/pages/settings/change_password_screen.dart`

**êµ¬í˜„ ë‚´ìš©**:
- ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
- ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ê²€ì¦ ê·œì¹™ í‘œì‹œ)
- ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥
- "ë³€ê²½" ë²„íŠ¼
- ì²« ë¡œê·¸ì¸ ì‹œ ê°•ì œ í‘œì‹œ ë¡œì§ (is_first_login check)

**4. ë¡œê·¸ì¸ í›„ ì²˜ë¦¬**
**íŒŒì¼**: `frontend/flutter_app/lib/data/repositories/auth_repository.dart`

**ì¶”ê°€ ë¡œì§**:
```dart
// ë¡œê·¸ì¸ ì„±ê³µ í›„
if (response.data['is_first_login'] == true) {
  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ìœ¼ë¡œ ê°•ì œ ì´ë™
  Navigator.pushReplacement(
    context,
    MaterialPageRoute(builder: (context) => ChangePasswordScreen(forceChange: true)),
  );
}
```

### 2. ìš´ì˜ í™˜ê²½ ì„¤ì •

#### í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env)
```bash
# í”„ë¡œë•ì…˜ ì•”í˜¸í™” í‚¤ ìƒì„±
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# .env íŒŒì¼ì— ì¶”ê°€
ENCRYPTION_KEY=ì‹¤ì œ_ìƒì„±ëœ_í‚¤
```

#### SMS ì„œë¹„ìŠ¤ ì—°ë™
- **í•œêµ­ SMS ì„œë¹„ìŠ¤ ì„ íƒ**:
  - Aligo SMS
  - NHN Cloud SMS
  - AWS SNS (í•œêµ­ ë²ˆí˜¸ ì§€ì›)

- **êµ¬í˜„ ìœ„ì¹˜**: `apps/users/utils.py` â†’ `send_sms()` í•¨ìˆ˜
- **í•„ìš” í™˜ê²½ ë³€ìˆ˜**: `SMS_API_KEY`, `SMS_SENDER_NUMBER`

### 3. ì¶”ê°€ ë³´ì•ˆ ê°•í™”

- [ ] SMS ì „ì†¡ Rate Limiting (1ë¶„ì— 3íšŒ ì œí•œ)
- [ ] ì£¼ë¯¼ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ (ì¡°íšŒ ì‹œ)
- [ ] ê°ì‚¬ ë¡œê·¸ (í™˜ì ë“±ë¡, SSN ì ‘ê·¼ ê¸°ë¡)
- [ ] ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê°•í™” (ìµœì†Œ 8ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ ë“±)

### 4. ë¬¸ì„œí™”

- [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸ (drf-spectacular)
- [ ] ê°„í˜¸ì‚¬ ì‚¬ìš©ì ë§¤ë‰´ì–¼ ì‘ì„±
- [ ] í™˜ì ì•± ì‚¬ìš© ì•ˆë‚´ë¬¸ ì‘ì„±

---

## ì£¼ì˜ì‚¬í•­

### ê°œë°œ í™˜ê²½
- SMS ì „ì†¡ì€ ë¡œê·¸ë¡œë§Œ ì¶œë ¥ (`logger.info`)
- ì•”í˜¸í™” í‚¤ëŠ” ê°œë°œìš© ê¸°ë³¸ê°’ ì‚¬ìš©
- í™˜ì ë“±ë¡ ì‹œ SMS ì•Œë¦¼ì´ ì‹¤ì œë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŒ

### í”„ë¡œë•ì…˜ ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] `ENCRYPTION_KEY` í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸
- [ ] SMS ì„œë¹„ìŠ¤ ì‹¤ì œ ì—°ë™ ë° í…ŒìŠ¤íŠ¸
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
- [ ] ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê²€í† 
- [ ] ê¶Œí•œ ì²´ê³„ ì¬í™•ì¸
- [ ] ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ì„¤ì •

---

## íŒŒì¼ ë³€ê²½ ì´ë ¥

### ì‹ ê·œ ìƒì„±
- `backend/django_main/apps/users/utils.py`
- `backend/django_main/apps/users/migrations/0004_userprofile_is_first_login.py`
- `backend/django_main/apps/emr/migrations/0002_patient_medical_record_number_patient_ssn_encrypted.py`

### ìˆ˜ì •
- `backend/django_main/apps/users/models.py` (+10 lines)
- `backend/django_main/apps/emr/models.py` (+18 lines)
- `backend/django_main/apps/users/serializers.py` (+143 lines)
- `backend/django_main/apps/users/views.py` (+153 lines)
- `backend/django_main/apps/users/permissions.py` (+13 lines)
- `backend/django_main/apps/users/urls.py` (+3 lines)
- `backend/django_main/neuronova/settings.py` (+7 lines)
- `backend/django_main/.env.example` (+4 lines)

---

## ì°¸ê³  ìë£Œ

- [Django Password Validation](https://docs.djangoproject.com/en/stable/topics/auth/passwords/)
- [Cryptography Fernet](https://cryptography.io/en/latest/fernet/)
- [Django REST Framework Permissions](https://www.django-rest-framework.org/api-guide/permissions/)
- [Simple JWT Documentation](https://django-rest-framework-simplejwt.readthedocs.io/)

---

**ë³´ê³ ì„œ ì¢…ë£Œ**
