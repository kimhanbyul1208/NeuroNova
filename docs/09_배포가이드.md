# NeuroNova 서버 배포 가이드

본 문서는 Docker를 사용하지 않고, Ubuntu 서버 환경에서 NeuroNova 프로젝트(Django + Flask + React)를 배포하기 위한 가이드입니다.

## 1. 전체 시스템 아키텍처

사용자는 Nginx를 통해 React 웹 애플리케이션(정적 파일)과 백엔드 API에 접근합니다. Nginx는 URL 경로에 따라 Django(메인 서버) 또는 Flask(AI 추론 서버)로 요청을 라우팅합니다.

```
[Flutter App]      [React Web]
      ↓                 ↓
               [Nginx]
      ┌──────────┴──────────┐
      │                     │
[Django (Gunicorn)]   [Flask AI (Gunicorn)]
      │                     │
      └──────────┬──────────┘
                 ↓
          [MySQL + Redis]
```

### 라우팅 규칙
- **`/`**: React 빌드 결과물 (Frontend)
- **`/api/`**: Django Main Server (Backend)
- **`/ai/`**: Flask Inference Server (AI)
- **`/static/`**: Django 정적 파일 (Admin, DRF UI 등)
- **`/media/`**: Django 미디어 파일 (업로드된 이미지 등)

---

## 2. 서버 폴더 구조

서버의 `/home/ubuntu/NeuroNova` 경로에 프로젝트가 위치한다고 가정합니다.

```
/home/ubuntu/NeuroNova/
├── backend/
│   ├── django_main/       # Django 메인 서버
│   │   ├── manage.py
│   │   ├── venv/          # Django용 가상환경
│   │   ├── staticfiles/   # collectstatic 결과물
│   │   └── ...
│   └── flask_inference/   # Flask AI 서버
│       ├── app.py
│       ├── venv/          # Flask용 가상환경
│       └── ...
├── frontend/
│   └── react_web/
│       ├── dist/          # React 빌드 결과물 (Nginx root)
│       └── ...
└── deploy/                # 배포 설정 파일 모음 (생성됨)
    ├── nginx/
    │   └── neuronova.conf
    └── systemd/
        ├── gunicorn_django.service
        └── gunicorn_flask.service
```

---

## 3. Nginx 설정 파일

`/etc/nginx/sites-available/neuronova` 경로에 생성합니다.

```nginx
server {
    listen 80;
    server_name YOUR_DOMAIN_OR_IP;

    # 1. React Frontend (Static Files)
    location / {
        root /home/ubuntu/NeuroNova/frontend/react_web/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 2. Django Backend API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Flask AI Server
    location /ai/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 4. Django Static Files
    location /static/ {
        alias /home/ubuntu/NeuroNova/backend/django_main/staticfiles/;
    }

    # 5. Django Media Files
    location /media/ {
        alias /home/ubuntu/NeuroNova/backend/django_main/media/;
    }
}
```

---

## 4. Django Gunicorn 서비스 파일

`/etc/systemd/system/gunicorn_django.service` 경로에 생성합니다.

```ini
[Unit]
Description=Gunicorn daemon for Django
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/NeuroNova/backend/django_main
# 가상환경의 gunicorn 실행
ExecStart=/home/ubuntu/NeuroNova/backend/django_main/venv/bin/gunicorn \
          --access-logfile - \
          --workers 3 \
          --bind 127.0.0.1:8000 \
          neuronova.wsgi:application

[Install]
WantedBy=multi-user.target
```

---

## 5. Flask Gunicorn 서비스 파일

`/etc/systemd/system/gunicorn_flask.service` 경로에 생성합니다.

```ini
[Unit]
Description=Gunicorn daemon for Flask AI
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/NeuroNova/backend/flask_inference
# 가상환경의 gunicorn 실행
ExecStart=/home/ubuntu/NeuroNova/backend/flask_inference/venv/bin/gunicorn \
          --access-logfile - \
          --workers 2 \
          --bind 127.0.0.1:5000 \
          app:app

[Install]
WantedBy=multi-user.target
```

---

## 6. Django collectstatic 구조 설명

Django는 개발 모드(`DEBUG=True`)에서는 정적 파일을 직접 서빙하지만, 배포 모드(`DEBUG=False`)에서는 Nginx가 서빙해야 합니다. 이를 위해 흩어져 있는 정적 파일들을 한 곳(`staticfiles`)으로 모으는 작업이 필요합니다.

1. `settings.py` 설정 확인:
   ```python
   STATIC_URL = '/static/'
   STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
   ```
2. 명령어 실행:
   ```bash
   python manage.py collectstatic
   ```
3. 결과: `backend/django_main/staticfiles/` 폴더에 모든 정적 파일이 복사됩니다.
4. Nginx 연결: Nginx 설정의 `alias /home/ubuntu/NeuroNova/backend/django_main/staticfiles/;` 부분이 이 폴더를 가리킵니다.

---

## 7. 배포 명령어 목록 (요약)

서버 접속 후 순서대로 실행하세요.

### 1) 코드 업데이트 및 폴더 준비
```bash
cd /home/ubuntu/NeuroNova
git pull origin main
mkdir -p backend/django_main/staticfiles
mkdir -p backend/django_main/media
```

### 2) Backend (Django) 설정
```bash
cd backend/django_main
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install gunicorn mysqlclient
python manage.py migrate
python manage.py collectstatic --noinput
deactivate
cd ../..
```

### 3) AI Server (Flask) 설정
```bash
cd backend/flask_inference
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install gunicorn
deactivate
cd ../..
```

### 4) Frontend (React) 빌드
```bash
cd frontend/react_web
npm install
npm run build
cd ../..
```

### 5) 설정 파일 적용 및 서비스 재시작
```bash
# Nginx 설정 복사 (최초 1회)
sudo cp deploy/nginx/neuronova.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/neuronova.conf /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# Systemd 서비스 복사 (최초 1회)
sudo cp deploy/systemd/*.service /etc/systemd/system/

# 데몬 리로드 및 재시작
sudo systemctl daemon-reload
sudo systemctl restart gunicorn_django
sudo systemctl restart gunicorn_flask
sudo systemctl restart nginx
```

---

## 8. 서버 보안/운영 체크리스트 (필수)

- [ ] **DEBUG 모드 끄기**: Django `settings.py`에서 `DEBUG = False` 설정.
- [ ] **ALLOWED_HOSTS 설정**: Django `settings.py`에 실제 도메인 또는 IP 추가.
- [ ] **비밀키 분리**: `SECRET_KEY`, DB 비밀번호 등은 `.env` 파일로 관리하고 git에 올리지 않음.
- [ ] **방화벽 설정 (UFW)**:
  ```bash
  sudo ufw allow 'Nginx Full'
  sudo ufw allow ssh
  sudo ufw enable
  ```
- [ ] **HTTPS 적용 (Certbot)**:
  ```bash
  sudo apt install certbot python3-certbot-nginx
  sudo certbot --nginx -d yourdomain.com
  ```
- [ ] **로그 확인**: 문제 발생 시 로그 확인
  - Nginx: `/var/log/nginx/error.log`
  - Django: `sudo journalctl -u gunicorn_django -f`
  - Flask: `sudo journalctl -u gunicorn_flask -f`
