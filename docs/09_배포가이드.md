# NeuroNova 서버 배포 가이드

본 문서는 Docker를 사용하지 않고, Ubuntu 서버 환경에서 NeuroNova 프로젝트(Django + Flask + React)를 배포하기 위한 가이드입니다.

## 1. 전체 시스템 아키텍처

보안을 위해 Flask ML 서버는 로컬 전용으로 동작하며, Django를 통해서만 접근 가능합니다. Nginx는 React 정적 파일을 서빙하고 Django만 프록시합니다.

```
[Flutter App]      [React Web]
      ↓                 ↓
              [Nginx:80]
                 │
                 ├── / : React 정적 파일 서빙
                 │
                 └── /api/, /admin/, /ml/ : Django 프록시
                                               ↓
                                    [Django:8000 (Gunicorn)]
                                               │
                                               ├── Django 앱 처리
                                               │
                                               └── /ml/* → Flask 프록시
                                                            ↓
                                               [Flask:127.0.0.1:9000 (Gunicorn)]
                                                     (로컬 전용, 외부 접근 불가)
                 ↓
          [MySQL + Redis]
```

### 라우팅 규칙
- **`/`**: React 빌드 결과물 (Frontend) - Nginx가 직접 서빙
- **`/api/`**: Django Main Server (Backend) - Nginx → Django
- **`/admin/`**: Django Admin - Nginx → Django
- **`/ml/`**: ML API - Nginx → Django → Flask (로컬)
- **`/static/`**: Django 정적 파일 (Admin, DRF UI 등) - Nginx가 직접 서빙
- **`/media/`**: Django 미디어 파일 (업로드된 이미지 등) - Nginx가 직접 서빙

### 보안 특징
✅ Flask는 `127.0.0.1:9000`에서만 동작 (외부 접근 차단)
✅ Django가 Flask로 프록시하여 보안 계층 추가
✅ Nginx는 Django만 프록시 (Flask 직접 노출 안 됨)

---

## 2. 서버 폴더 구조

서버의 `/home/acorn/NeuroNova` 경로에 프로젝트가 위치한다고 가정합니다.

```
/home/acorn/NeuroNova/           # Git 저장소 클론 위치
├── backend/
│   ├── django_main/             # Django 메인 서버
│   │   ├── manage.py
│   │   ├── venv/                # Django용 가상환경
│   │   ├── staticfiles/         # collectstatic 결과물
│   │   └── ...
│   └── flask_inference/         # Flask AI 서버
│       ├── app.py
│       ├── venv/                # Flask용 가상환경
│       └── ...
├── frontend/
│   └── react_web/
│       ├── dist/                # React 빌드 결과물 (Nginx root)
│       └── ...
└── deploy/                      # 배포 설정 파일 모음 (생성됨)
    ├── nginx/
    │   └── neuronova.conf
    └── systemd/
        ├── gunicorn_django.service
        └── gunicorn_flask.service

/var/www/                        # Nginx 서빙 디렉토리 (미리 생성)
├── react/
├── django_project/
├── flask_ai/
└── django_static/
```

> **주의**: 위 경로에서 `acorn`은 서버의 사용자 계정 이름입니다. 다른 사용자 이름인 경우 모든 설정 파일에서 경로를 변경해야 합니다.

---

## 3. Nginx 설정 파일

`/etc/nginx/sites-available/neuronova` 경로에 생성합니다.

```nginx
server {
    listen 80;
    server_name YOUR_DOMAIN_OR_IP;

    client_max_body_size 100M;  # DICOM 파일 업로드용

    # 1. React Frontend (Static Files)
    location / {
        root /home/ubuntu/NeuroNova/frontend/react_web/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 2. Django Backend API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 3. Django Admin
    location /admin/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 4. ML API (Django를 통해 Flask로 프록시됨)
    # Flask는 127.0.0.1:9000에서 로컬 전용으로 동작
    # Django가 Flask로 요청을 전달
    location /ml/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # AI 추론은 시간이 오래 걸릴 수 있음
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # 5. Django Static Files
    location /static/ {
        alias /home/ubuntu/NeuroNova/backend/django_main/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 6. Django Media Files
    location /media/ {
        alias /home/ubuntu/NeuroNova/backend/django_main/media/;
        expires 30d;
        add_header Cache-Control "public";
    }
}
```

> **주의**: 위 설정에서 `/home/ubuntu`는 서버의 사용자 계정 이름입니다.
> 다른 사용자 이름을 사용하는 경우 (예: `acorn`), 경로를 `/home/acorn/NeuroNova`로 변경해야 합니다.
>
> **중요**: Flask ML 서버는 Nginx에서 직접 프록시하지 않습니다. `/ml/` 경로로 들어온 요청은 Django로 전달되고, Django가 내부적으로 Flask(`127.0.0.1:9000`)로 프록시합니다.

---

## 4. Django Gunicorn 서비스 파일

`/etc/systemd/system/gunicorn_django.service` 경로에 생성합니다.

```ini
[Unit]
Description=Gunicorn daemon for Django
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/NeuroNova/backend/django_main
Environment="PATH=/home/ubuntu/NeuroNova/backend/django_main/venv/bin"
ExecStart=/home/ubuntu/NeuroNova/backend/django_main/venv/bin/gunicorn \
          --access-logfile - \
          --error-logfile - \
          --workers 3 \
          --bind 127.0.0.1:8000 \
          --timeout 120 \
          neuronova.wsgi:application

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

> **주의**:
> - `User=ubuntu`는 서버의 사용자 계정 이름입니다. 다른 사용자 이름인 경우 변경하세요.
> - Django는 `127.0.0.1:8000`에서 동작합니다.

---

## 5. Flask Gunicorn 서비스 파일

`/etc/systemd/system/gunicorn_flask.service` 경로에 생성합니다.

```ini
[Unit]
Description=Gunicorn daemon for Flask AI (로컬 전용)
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/NeuroNova/backend/flask_inference
Environment="PATH=/home/ubuntu/NeuroNova/backend/flask_inference/venv/bin"
ExecStart=/home/ubuntu/NeuroNova/backend/flask_inference/venv/bin/gunicorn \
          --access-logfile - \
          --error-logfile - \
          --workers 2 \
          --bind 127.0.0.1:9000 \
          --timeout 300 \
          app:app

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

> **주의**:
> - `User=ubuntu`는 서버의 사용자 계정 이름입니다. 다른 사용자 이름인 경우 변경하세요.
> - Flask는 `127.0.0.1:9000`에서 **로컬 전용**으로 동작합니다 (외부 접근 불가).
> - Django의 `ml_proxy` 앱이 Flask로 요청을 프록시합니다.
> - `--timeout 300`: AI 추론은 시간이 오래 걸릴 수 있으므로 타임아웃을 5분으로 설정.

---

## 6. Django collectstatic 구조 설명

Django는 개발 모드(`DEBUG=True`)에서는 정적 파일을 직접 서빙하지만, 배포 모드(`DEBUG=False`)에서는 Nginx가 서빙해야 합니다. 이를 위해 흩어져 있는 정적 파일들을 한 곳(`staticfiles`)으로 모으는 작업이 필요합니다.

1. `settings.py` 설정 확인:
   ```python
   STATIC_URL = '/static/'
   STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
   ```
2. 명령어 실행:
   ```bash
   python manage.py collectstatic
   ```
3. 결과: `backend/django_main/staticfiles/` 폴더에 모든 정적 파일이 복사됩니다.
4. Nginx 연결: Nginx 설정의 `alias /home/acorn/NeuroNova/backend/django_main/staticfiles/;` 부분이 이 폴더를 가리킵니다.

---

## 7. 배포 명령어 목록 (요약)

서버 접속 후 순서대로 실행하세요.

### 1) 서버 접속 (PuTTY 사용)
1. PuTTY를 실행합니다.
2. Host Name에 서버 IP 주소를 입력합니다.
3. Port는 22 (SSH 기본 포트)로 설정합니다.
4. Connection type은 SSH로 선택합니다.
5. Open 버튼을 클릭하여 접속합니다.
6. 사용자 이름과 비밀번호(또는 SSH 키)로 로그인합니다.

### 2) 필수 패키지 설치 (최초 1회)
```bash
# 시스템 패키지 업데이트
sudo apt-get update

# Nginx 설치
# sudo apt-get install nginx -y

# Python 및 필수 라이브러리 설치
sudo apt-get install python3-dev python3-venv python3-pip -y
sudo apt-get install libmariadb-dev build-essential -y

# Node.js 및 npm 설치 (React 빌드용)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install nodejs -y
```

> **주의**: 이 단계는 최초 서버 세팅 시 **1회만** 실행하면 됩니다.

### 3) Git 저장소 클론 (최초 1회)
처음 배포하는 경우, 프로젝트를 서버에 클론합니다.

```bash
# 홈 디렉토리로 이동
cd ~

# Git 저장소 클론
git clone https://github.com/kimhanbyul1208/NeuroNova.git

# 클론 확인
ls -la NeuroNova
```

> **주의**:
> - 이 단계는 최초 배포 시 **1회만** 실행합니다.
> - 이후 배포에서는 `git pull`만 실행하면 됩니다.
> - Private 저장소인 경우, GitHub Personal Access Token이나 SSH 키 설정이 필요합니다.

### 4) 코드 업데이트 및 폴더 준비
```bash
cd ~/NeuroNova
git pull origin main
mkdir -p backend/django_main/staticfiles
mkdir -p backend/django_main/media
```

### 5) Backend (Django) 설정
```bash
cd backend/django_main
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install python-dotenv
pip install -r requirements.txt
pip install gunicorn mysqlclient
python manage.py migrate
python manage.py collectstatic --noinput
deactivate
cd ../..
```

> **주의**:
> - `python-dotenv`는 Django settings에서 환경 변수 파일(.env)을 읽기 위해 필요합니다.
> - `mysqlclient` 설치가 실패하는 경우, 위의 **2) 필수 패키지 설치** 단계를 먼저 수행했는지 확인하세요.

### 6) AI Server (Flask) 설정
```bash
cd backend/flask_inference
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install python-dotenv
pip install -r requirements.txt
pip install gunicorn
deactivate
cd ../..
```

### 7) Frontend (React) 빌드
```bash
cd frontend/react_web
npm install
npm run build
cd ../..
```

### 8) 설정 파일 적용 및 서비스 재시작
```bash
# Nginx 설정 복사 (최초 1회)
sudo cp deploy/nginx/neuronova.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/neuronova.conf /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# Systemd 서비스 복사 (최초 1회)
sudo cp deploy/systemd/*.service /etc/systemd/system/

# 데몬 리로드 및 재시작
sudo systemctl daemon-reload
sudo systemctl restart gunicorn_django
sudo systemctl restart gunicorn_flask
sudo systemctl restart nginx
```

---

## 8. 아키텍처 상세 설명

### Django ml_proxy 앱의 역할

Django의 `ml_proxy` 앱은 Flask ML 서버로 요청을 프록시하는 중간 계층입니다.

**요청 흐름:**
```
클라이언트 → Nginx:80 → Django:8000 → Flask:127.0.0.1:9000
   |              |            |                |
   |              |            |                └─ ML 추론 수행
   |              |            └─ ml_proxy 앱이 Flask로 프록시
   |              └─ /ml/ 경로를 Django로 프록시
   └─ POST /ml/v1/predict
```

**엔드포인트:**
- `POST /ml/v1/predict/`: AI 추론 요청 (Django가 Flask로 프록시)
- `GET /ml/v1/status/`: Flask 서버 상태 조회
- `GET /ml/v1/model-info/`: 모델 정보 조회
- `POST /ml/v1/retrain/`: 모델 재학습 요청
- `GET /ml/v1/history/`: 추론 이력 조회 (Django DB 저장)

**보안 이점:**
1. Flask는 로컬 전용(`127.0.0.1:9000`)으로 동작하여 외부에서 직접 접근 불가
2. Django에서 인증/인가 로직 추가 가능
3. Django에서 추론 요청/응답을 로깅하여 감사 추적 가능
4. Rate limiting, API 키 검증 등 추가 보안 계층 구현 가능

### Flask 포트 변경 사항

- **기존**: Flask가 포트 5000에서 동작
- **변경**: Flask가 포트 9000에서 동작
- **이유**: 포트 5000은 macOS에서 AirPlay와 충돌할 수 있으며, 9000번 포트가 더 명확한 구분

### 환경 변수 설정

**Django `.env` 파일 (`backend/django_main/.env`):**
```bash
# Flask ML 서버 (로컬 전용)
FLASK_INFERENCE_URL=http://127.0.0.1:9000
```

**Flask `.env` 파일 (`backend/flask_inference/.env`):**
```bash
# 포트 설정
PORT=9000

# 모델 디렉토리
MODEL_DIR=./final_model
```

---

## 9. 서버 보안/운영 체크리스트 (필수)

- [ ] **DEBUG 모드 끄기**: Django `settings.py`에서 `DEBUG = False` 설정.
- [ ] **ALLOWED_HOSTS 설정**: Django `settings.py`에 실제 도메인 또는 IP 추가.
- [ ] **비밀키 분리**: `SECRET_KEY`, DB 비밀번호 등은 `.env` 파일로 관리하고 git에 올리지 않음.
- [ ] **Flask 로컬 전용 확인**: Flask가 `127.0.0.1:9000`에서만 동작하는지 확인 (외부 접근 불가)
- [ ] **방화벽 설정 (UFW)**:
  ```bash
  sudo ufw allow 'Nginx Full'
  sudo ufw allow ssh
  sudo ufw enable

  # Flask 포트는 외부에서 접근 불가하도록 차단 (이미 127.0.0.1로 바인딩되어 있음)
  # Django 포트도 외부 접근 차단 (Nginx를 통해서만 접근)
  ```
- [ ] **HTTPS 적용 (Certbot)**:
  ```bash
  sudo apt install certbot python3-certbot-nginx
  sudo certbot --nginx -d yourdomain.com
  ```
- [ ] **로그 확인**: 문제 발생 시 로그 확인
  - Nginx: `/var/log/nginx/error.log`
  - Django: `sudo journalctl -u gunicorn_django -f`
  - Flask: `sudo journalctl -u gunicorn_flask -f`

### 서비스 상태 확인 및 재시작

```bash
# 서비스 상태 확인
sudo systemctl status gunicorn_django
sudo systemctl status gunicorn_flask
sudo systemctl status nginx

# 서비스 재시작
sudo systemctl restart gunicorn_django
sudo systemctl restart gunicorn_flask
sudo systemctl restart nginx

# 서비스 로그 실시간 확인
sudo journalctl -u gunicorn_django -f
sudo journalctl -u gunicorn_flask -f
```

### 트러블슈팅

**Flask 연결 오류 (502 Bad Gateway):**
1. Flask 서비스가 실행 중인지 확인: `sudo systemctl status gunicorn_flask`
2. Flask가 127.0.0.1:9000에서 리스닝 중인지 확인: `sudo netstat -tulpn | grep 9000`
3. Django settings에서 `FLASK_INFERENCE_URL`이 올바른지 확인
4. Flask 로그 확인: `sudo journalctl -u gunicorn_flask -n 50`

**Django ml_proxy 오류:**
1. Django 로그 확인: `sudo journalctl -u gunicorn_django -n 50`
2. Django에서 Flask로 연결 테스트:
   ```bash
   # Django 서버에서 실행
   curl http://127.0.0.1:9000/health
   ```
