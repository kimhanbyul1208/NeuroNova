# 캐싱 전략 검증 가이드

## 목차
1. [자동 테스트](#자동-테스트)
2. [수동 테스트](#수동-테스트)
3. [브라우저 테스트](#브라우저-테스트)
4. [성능 측정](#성능-측정)
5. [트러블슈팅](#트러블슈팅)

---

## 자동 테스트

### 테스트 스크립트 실행

```bash
cd ~/NeuroNova/deploy/scripts
bash test_caching.sh localhost

# 또는 도메인으로
bash test_caching.sh neuronova.example.com
```

### 테스트 항목

스크립트는 다음을 자동으로 검증합니다:

1. **HTML 파일**: 캐싱 안 함 (`no-cache, no-store`)
2. **JavaScript 파일**: 1년 캐싱 (`max-age=31536000, immutable`)
3. **CSS 파일**: 1년 캐싱 (`max-age=31536000, immutable`)
4. **API 응답**: 캐싱 안 함
5. **Django Static**: 1년 캐싱
6. **gzip 압축**: 활성화 확인
7. **Brotli 압축**: 활성화 확인 (선택)
8. **보안 헤더**: X-Frame-Options, HSTS 등

### 예상 출력

```
============================================
캐싱 전략 테스트
============================================
대상: http://localhost

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
테스트: HTML (index.html)
URL: http://localhost/

HTTP 상태: 200
Cache-Control: no-cache, no-store, must-revalidate
Expires: 0

✅ 통과: 올바른 캐시 헤더

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
테스트: JavaScript
URL: http://localhost/assets/index-abc123.js

HTTP 상태: 200
Cache-Control: public, max-age=31536000, immutable
Content-Encoding: gzip

✅ 통과: 올바른 캐시 헤더

...

============================================
테스트 결과 요약
============================================
통과: 7 / 7

✅ 모든 테스트 통과!

캐싱 전략이 올바르게 작동하고 있습니다.
```

---

## 수동 테스트

### 1. HTML 파일 캐싱 확인

```bash
curl -I http://localhost/ | grep -i cache-control
```

**예상 출력:**
```
Cache-Control: no-cache, no-store, must-revalidate
```

**의미:** HTML은 항상 최신 버전 제공

### 2. JavaScript/CSS 캐싱 확인

```bash
# React 빌드 파일 찾기
curl -s http://localhost/ | grep -o 'src="[^"]*\.js"' | head -1

# 해당 JS 파일 헤더 확인
curl -I http://localhost/assets/index-abc123.js | grep -i cache-control
```

**예상 출력:**
```
Cache-Control: public, max-age=31536000, immutable
```

**의미:** 1년간 브라우저 캐싱 (파일명에 해시 포함)

### 3. gzip 압축 확인

```bash
curl -H "Accept-Encoding: gzip" -I http://localhost/ | grep -i content-encoding
```

**예상 출력:**
```
Content-Encoding: gzip
```

**압축률 측정:**
```bash
# 압축 전 크기
curl -H "Accept-Encoding: identity" http://localhost/assets/index.js -o /dev/null -s -w 'Size: %{size_download} bytes\n'

# 압축 후 크기
curl -H "Accept-Encoding: gzip" http://localhost/assets/index.js -o /dev/null -s -w 'Size: %{size_download} bytes\n'
```

**예상 결과:**
```
압축 전: 500,000 bytes (500 KB)
압축 후: 125,000 bytes (125 KB)
압축률: 75%
```

### 4. Brotli 압축 확인

```bash
curl -H "Accept-Encoding: br" -I http://localhost/ | grep -i content-encoding
```

**예상 출력:**
```
Content-Encoding: br
```

**Brotli vs gzip 비교:**
```bash
# gzip 크기
curl -H "Accept-Encoding: gzip" http://localhost/assets/index.js -o /dev/null -s -w '%{size_download}\n'

# Brotli 크기
curl -H "Accept-Encoding: br" http://localhost/assets/index.js -o /dev/null -s -w '%{size_download}\n'
```

**예상 결과:**
```
gzip:    125,000 bytes
Brotli:  100,000 bytes (20% 더 압축)
```

### 5. ETag 확인

```bash
curl -I http://localhost/static/admin/css/base.css | grep -i etag
```

**예상 출력:**
```
ETag: "abc123-def456"
```

**조건부 요청 테스트:**
```bash
# ETag 값 가져오기
ETAG=$(curl -I http://localhost/static/admin/css/base.css | grep -i etag | cut -d: -f2 | tr -d ' \r')

# If-None-Match로 재요청
curl -H "If-None-Match: $ETAG" -I http://localhost/static/admin/css/base.css
```

**예상 출력:**
```
HTTP/1.1 304 Not Modified
```

**의미:** 파일이 변경되지 않아 전송 생략 (대역폭 절약)

---

## 브라우저 테스트

### Chrome DevTools로 확인

#### 1. 개발자 도구 열기
- F12 또는 우클릭 → 검사
- Network 탭 선택

#### 2. 캐시 비우기 및 새로고침
- Ctrl + Shift + R (캐시 무시 새로고침)
- 또는 Network 탭에서 "Disable cache" 체크 해제

#### 3. 페이지 로드 관찰

**최초 방문:**
```
Name              Status  Type        Size      Time
index.html        200     document    15 KB     200ms
index-abc123.js   200     script      125 KB    400ms  (gzip)
index-def456.css  200     stylesheet  30 KB     150ms  (gzip)
logo.png          200     png         50 KB     100ms
```

**재방문 (캐시 사용):**
```
Name              Status  Type        Size      Time
index.html        200     document    15 KB     50ms   (from cache)
index-abc123.js   (disk cache)       0 B       0ms
index-def456.css  (disk cache)       0 B       0ms
logo.png          (disk cache)       0 B       0ms
```

#### 4. Response Headers 확인

파일 클릭 → Headers 탭:

**JavaScript 파일:**
```
Cache-Control: public, max-age=31536000, immutable
Content-Encoding: gzip
Content-Type: application/javascript
```

**HTML 파일:**
```
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
```

### Lighthouse 성능 감사

#### 1. Lighthouse 실행
- Chrome DevTools → Lighthouse 탭
- "Performance" 체크
- "Analyze page load" 클릭

#### 2. 캐싱 관련 지표 확인

**최적화 전:**
```
Performance: 65
Metrics:
  - Total Blocking Time: 500ms
  - Largest Contentful Paint: 3.5s

Opportunities:
  ❌ Serve static assets with an efficient cache policy
  ❌ Enable text compression
```

**최적화 후:**
```
Performance: 95
Metrics:
  - Total Blocking Time: 100ms
  - Largest Contentful Paint: 1.2s

Passed audits:
  ✅ Serve static assets with an efficient cache policy
  ✅ Enable text compression
  ✅ Uses efficient cache policy on static assets
```

---

## 성능 측정

### 1. 로딩 속도 비교

#### WebPageTest 사용
```
https://www.webpagetest.org/
```

**테스트 설정:**
- URL 입력
- Location: Seoul, South Korea
- Browser: Chrome
- Run Test

**결과 비교:**

| 항목 | 최적화 전 | 최적화 후 | 개선율 |
|------|----------|----------|--------|
| First Byte | 200ms | 180ms | 10% |
| Start Render | 1.5s | 0.8s | 47% |
| Fully Loaded | 5.0s | 1.5s | 70% |
| Total Size | 5.0 MB | 1.2 MB | 76% |
| Requests | 50 | 50 | 0% |

### 2. 대역폭 절감 측정

```bash
# 방문자 수: 10,000/월
# 평균 페이지뷰: 5 페이지

# 최적화 전:
# 페이지당 5MB × 5 페이지 × 10,000 명 = 250 GB/월

# 최적화 후:
# 초회 방문: 1.2MB × 5 페이지 = 6MB
# 재방문: 0.05MB × 5 페이지 = 0.25MB (캐시 사용)
# 평균 (초회 20%, 재방문 80%):
#   6MB × 0.2 + 0.25MB × 0.8 = 1.4MB/방문
# 총 대역폭: 1.4MB × 10,000 = 14 GB/월

# 절감: 250GB - 14GB = 236GB (94% 절감)
```

### 3. 서버 부하 측정

#### Apache Bench (ab) 사용

```bash
# 캐싱 없이 100 요청
ab -n 100 -c 10 http://localhost/

# 캐싱 활성화 후 100 요청
ab -n 100 -c 10 -H "Accept-Encoding: gzip" http://localhost/
```

**결과 비교:**

| 지표 | 캐싱 전 | 캐싱 후 |
|------|--------|---------|
| 초당 요청 | 50 req/s | 200 req/s |
| 평균 응답 | 200ms | 50ms |
| 전송량 | 500 MB | 125 MB |

---

## 트러블슈팅

### 1. 캐시 헤더가 설정되지 않음

**증상:**
```bash
curl -I http://localhost/assets/index.js
# Cache-Control 헤더 없음
```

**원인:**
- Nginx 설정 오류
- location 블록 순서 문제
- 설정 파일 미적용

**해결:**
```bash
# Nginx 설정 확인
sudo nginx -t

# 설정 재로드
sudo systemctl reload nginx

# location 블록 순서 확인
# 더 구체적인 패턴이 먼저 와야 함
location ~* \.js$ {  # 이게 먼저
    expires 1y;
}
location / {  # 이게 나중
    try_files $uri /index.html;
}
```

### 2. HTML이 캐싱됨 (업데이트 반영 안 됨)

**증상:**
```
배포 후에도 구버전 페이지 표시
```

**확인:**
```bash
curl -I http://localhost/ | grep -i cache-control
# 출력: Cache-Control: public, max-age=3600 (잘못됨!)
```

**해결:**
```nginx
# HTML은 반드시 캐싱하지 않음
location ~ \.html$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    expires -1;
}
```

### 3. 압축이 작동하지 않음

**증상:**
```bash
curl -H "Accept-Encoding: gzip" -I http://localhost/
# Content-Encoding 헤더 없음
```

**원인 1: gzip 설정 누락**
```bash
# /etc/nginx/conf.d/gzip.conf 확인
ls -la /etc/nginx/conf.d/gzip.conf

# 없으면 설치
cd ~/NeuroNova/deploy/scripts
sudo bash optimize_gzip.sh
```

**원인 2: 파일 크기가 너무 작음**
```nginx
# gzip_min_length 확인
gzip_min_length 256;  # 256 bytes 이상만 압축
```

**원인 3: MIME 타입 누락**
```nginx
# gzip_types에 MIME 타입 추가
gzip_types
    text/plain
    text/css
    application/javascript
    application/json;
```

### 4. Brotli 압축 실패

**증상:**
```bash
curl -H "Accept-Encoding: br" -I http://localhost/
# Content-Encoding: gzip (br이 아님)
```

**원인: Brotli 모듈 미설치**
```bash
# Brotli 모듈 확인
nginx -V 2>&1 | grep brotli

# 없으면 설치
cd ~/NeuroNova/deploy/scripts
sudo bash enable_brotli.sh
```

### 5. 304 Not Modified가 반환되지 않음

**증상:**
```bash
# 같은 파일을 두 번 요청해도 200 반환
curl -I http://localhost/static/admin/css/base.css
# 항상 200 OK (파일 전체 전송)
```

**원인: ETag 비활성화**
```nginx
# ETag 활성화
location /static/ {
    etag on;  # 추가
}
```

### 6. immutable 속성이 무시됨

**증상:**
브라우저가 재검증 요청을 보냄

**원인: 브라우저 호환성**
- Safari, Edge는 immutable 미지원 (괜찮음, max-age만으로 충분)
- Chrome/Firefox는 정상 작동

**확인:**
```nginx
# max-age가 충분히 긴지 확인
Cache-Control: public, max-age=31536000, immutable
#                              ^^^^^^^^^ 1년
```

---

## 캐싱 전략 체크리스트

배포 후 다음을 확인하세요:

**기본 검증:**
- [ ] HTML 파일: `Cache-Control: no-cache` 확인
- [ ] JS/CSS 파일: `max-age=31536000, immutable` 확인
- [ ] 이미지 파일: `max-age=15552000` (6개월) 확인
- [ ] API 응답: 캐싱 안 함 확인

**압축 검증:**
- [ ] gzip 활성화: `Content-Encoding: gzip` 확인
- [ ] Brotli 활성화: `Content-Encoding: br` 확인 (선택)
- [ ] 압축률 70% 이상 달성

**성능 검증:**
- [ ] Lighthouse 점수 90+ 달성
- [ ] 재방문 시 로딩 시간 80% 이상 단축
- [ ] 대역폭 사용량 70% 이상 절감

**보안 검증:**
- [ ] 보안 헤더 설정 (X-Frame-Options 등)
- [ ] HTTPS 사용 시 HSTS 활성화
- [ ] 민감한 데이터는 캐싱 안 함

---

**문서 버전**: 1.0
**최종 수정일**: 2025-12-06
**작성자**: NeuroNova 개발팀
