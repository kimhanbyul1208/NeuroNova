# í™˜ì ë“±ë¡ ì‹œìŠ¤í…œ ì „ì²´ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-12-06
**ë²„ì „**: 1.0
**ìƒíƒœ**: âœ… ì „ì²´ êµ¬í˜„ ì™„ë£Œ

---

## ğŸ“‹ ëª©ì°¨

1. [êµ¬í˜„ ê°œìš”](#êµ¬í˜„-ê°œìš”)
2. [ë°±ì—”ë“œ êµ¬í˜„ ìƒì„¸](#ë°±ì—”ë“œ-êµ¬í˜„-ìƒì„¸)
3. [í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ ìƒì„¸](#í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„-ìƒì„¸)
4. [í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤](#í…ŒìŠ¤íŠ¸-ì‹œë‚˜ë¦¬ì˜¤)
5. [ë°°í¬ ê°€ì´ë“œ](#ë°°í¬-ê°€ì´ë“œ)
6. [ë‹¤ìŒ ë‹¨ê³„](#ë‹¤ìŒ-ë‹¨ê³„)

---

## êµ¬í˜„ ê°œìš”

### ğŸ¯ ëª©í‘œ
ê°„í˜¸ì‚¬ ì£¼ë„ì˜ í™˜ì ë“±ë¡ ì‹œìŠ¤í…œ êµ¬ì¶• ë° SMS ê¸°ë°˜ ë¡œê·¸ì¸ ì§€ì›

### âœ… ì™„ë£Œëœ ê¸°ëŠ¥

#### ë°±ì—”ë“œ (Django)
- [x] User ëª¨ë¸ì— `is_first_login` í•„ë“œ ì¶”ê°€
- [x] Patient ëª¨ë¸ì— `ssn_encrypted`, `medical_record_number` í•„ë“œ ì¶”ê°€
- [x] ì£¼ë¯¼ë²ˆí˜¸ Fernet ì•”í˜¸í™”/ë³µí˜¸í™” ìœ í‹¸ë¦¬í‹°
- [x] SMS ì¸ì¦ ì½”ë“œ ìƒì„± ë° ì „ì†¡ ìœ í‹¸ë¦¬í‹°
- [x] ë³‘ì› ë“±ë¡ë²ˆí˜¸/í™˜ì ID ìë™ ìƒì„± í•¨ìˆ˜
- [x] `NursePatientRegistrationSerializer` êµ¬í˜„
- [x] `NursePatientViewSet` (ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ API)
- [x] SMS ì¸ì¦ ì½”ë“œ ìš”ì²­ API (`sms_request_code`)
- [x] SMS ì¸ì¦ ë° ë¡œê·¸ì¸ API (`sms_verify_and_login`)
- [x] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API (`change_password`) - is_first_login í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
- [x] `IsNurseOrAdmin` ê¶Œí•œ í´ë˜ìŠ¤
- [x] URL ë¼ìš°íŒ… ì„¤ì •
- [x] settings.pyì— `ENCRYPTION_KEY` ì¶”ê°€
- [x] Database migration íŒŒì¼ ìƒì„±

#### í”„ë¡ íŠ¸ì—”ë“œ - Flutter (í™˜ììš© ëª¨ë°”ì¼ ì•±)
- [x] AuthRepositoryì— SMS ë¡œê·¸ì¸ ë©”ì„œë“œ ì¶”ê°€
- [x] AuthRepositoryì— ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë©”ì„œë“œ ì¶”ê°€
- [x] AuthRepositoryì— is_first_login ì²´í¬ ë©”ì„œë“œ ì¶”ê°€
- [x] ë¡œê·¸ì¸ í™”ë©´ì— SMS ë¡œê·¸ì¸ ë²„íŠ¼ ì¶”ê°€
- [x] SMS ë¡œê·¸ì¸ í™”ë©´ (`SmsLoginScreen`) êµ¬í˜„
  - ì „í™”ë²ˆí˜¸ ì…ë ¥ ë° ê²€ì¦
  - SMS ì½”ë“œ ìš”ì²­
  - 5ë¶„ íƒ€ì´ë¨¸ í‘œì‹œ
  - 6ìë¦¬ ì½”ë“œ ì…ë ¥ ë° ê²€ì¦
- [x] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ (`ChangePasswordScreen`) êµ¬í˜„
  - ê¸°ì¡´/ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
  - ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦
  - ì²« ë¡œê·¸ì¸ ì‹œ ê°•ì œ ë³€ê²½ ëª¨ë“œ
- [x] ë¡œê·¸ì¸ í›„ is_first_login ì²´í¬ ë¡œì§
- [x] ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ìœ¼ë¡œ ìë™ ì´ë™

#### í”„ë¡ íŠ¸ì—”ë“œ - React (ê°„í˜¸ì‚¬/ê´€ë¦¬ììš© ì›¹)
- [x] í™˜ì ë“±ë¡ í˜ì´ì§€ (`PatientRegistration.jsx`) êµ¬í˜„
  - í™˜ì ì •ë³´ ì…ë ¥ í¼ (ì´ë¦„, ì£¼ë¯¼ë²ˆí˜¸, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ ë“±)
  - ë‹´ë‹¹ ì˜ì‚¬ ì„ íƒ ë“œë¡­ë‹¤ìš´
  - ì „í™”ë²ˆí˜¸/ì£¼ë¯¼ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
  - ë“±ë¡ ì™„ë£Œ í›„ ê²°ê³¼ ë‹¤ì´ì–¼ë¡œê·¸
  - ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë° ë¡œê·¸ì¸ ì •ë³´ í‘œì‹œ
  - ë³µì‚¬ ë° ì¸ì‡„ ê¸°ëŠ¥

---

## ë°±ì—”ë“œ êµ¬í˜„ ìƒì„¸

### 1. ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½

#### Migration íŒŒì¼
1. **users/migrations/0004_userprofile_is_first_login.py**
   - `UserProfile.is_first_login` í•„ë“œ ì¶”ê°€ (BooleanField, default=True)

2. **emr/migrations/0002_patient_medical_record_number_patient_ssn_encrypted.py**
   - `Patient.ssn_encrypted` í•„ë“œ ì¶”ê°€ (BinaryField)
   - `Patient.medical_record_number` í•„ë“œ ì¶”ê°€ (CharField, unique=True)

### 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (apps/users/utils.py)

```python
# ì•”í˜¸í™”
- get_encryption_key() -> bytes
- encrypt_ssn(ssn: str) -> bytes
- decrypt_ssn(encrypted_ssn: bytes) -> str

# SMS
- generate_sms_code(length: int = 6) -> str
- send_sms(phone_number: str, message: str) -> bool

# ë²ˆí˜¸ ìƒì„±
- normalize_phone_number(phone: str) -> str
- generate_medical_record_number() -> str  # MR-YYYYMMDD-NNNN
- generate_patient_pid() -> str  # PT-YYYYMMDD-NNNN
```

### 3. API ì—”ë“œí¬ì¸íŠ¸

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… | ê¶Œí•œ |
|--------|-----------|------|------|
| POST | `/api/v1/users/nurse/register_patient/` | ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ | Nurse/Admin |
| POST | `/api/v1/users/sms/request/` | SMS ì¸ì¦ ì½”ë“œ ìš”ì²­ | AllowAny |
| POST | `/api/v1/users/sms/verify/` | SMS ì¸ì¦ ë° ë¡œê·¸ì¸ | AllowAny |
| POST | `/api/v1/users/change_password/` | ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ | Authenticated |

### 4. ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ API

**Request**:
```json
{
  "first_name": "ê¸¸ë™",
  "last_name": "í™",
  "ssn": "900101-1234567",
  "phone": "010-1234-5678",
  "date_of_birth": "1990-01-01",
  "gender": "M",
  "doctor_id": 5,
  "address": "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
  "email": "hong@example.com",
  "emergency_contact": "010-9876-5432",
  "insurance_id": "123456789"
}
```

**Response (201 Created)**:
```json
{
  "message": "í™˜ì ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
  "patient_id": 42,
  "pid": "PT-20250106-0001",
  "medical_record_number": "MR-20250106-0001",
  "username": "01012345678",
  "temp_password": "testpass123"
}
```

### 5. SMS ì¸ì¦ íë¦„

#### Step 1: SMS ì½”ë“œ ìš”ì²­
```bash
POST /api/v1/users/sms/request/
{
  "phone": "010-1234-5678"
}

Response (200 OK):
{
  "message": "SMS ì¸ì¦ ì½”ë“œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "expires_in": 300
}
```

#### Step 2: SMS ì¸ì¦ ë° ë¡œê·¸ì¸
```bash
POST /api/v1/users/sms/verify/
{
  "phone": "010-1234-5678",
  "code": "123456"
}

Response (200 OK):
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": { ... },
  "is_first_login": true
}
```

---

## í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ ìƒì„¸

### Flutter (í™˜ììš© ëª¨ë°”ì¼ ì•±)

#### 1. AuthRepository í™•ì¥

**ì‹ ê·œ ë©”ì„œë“œ**:
```dart
// SMS ì¸ì¦ ì½”ë“œ ìš”ì²­
Future<int> requestSmsCode(String phone)

// SMS ì¸ì¦ ë° ë¡œê·¸ì¸
Future<Map<String, dynamic>> verifySmsAndLogin(String phone, String code)

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
Future<void> changePassword({
  required String oldPassword,
  required String newPassword,
  required String newPasswordConfirm,
})

// ì²« ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
Future<bool> isFirstLogin()
```

#### 2. ë¡œê·¸ì¸ í™”ë©´ (`login_screen.dart`)

**ë³€ê²½ì‚¬í•­**:
- SMS ë¡œê·¸ì¸ ë²„íŠ¼ ì¶”ê°€
- ë¡œê·¸ì¸ í›„ `is_first_login` ì²´í¬
- ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ìœ¼ë¡œ ìë™ ì´ë™

**ì½”ë“œ**:
```dart
if (isFirstLogin) {
  Navigator.of(context).pushReplacementNamed(
    '/change-password',
    arguments: {'forceChange': true},
  );
} else {
  Navigator.of(context).pushReplacementNamed('/home');
}
```

#### 3. SMS ë¡œê·¸ì¸ í™”ë©´ (`sms_login_screen.dart`)

**ì£¼ìš” ê¸°ëŠ¥**:
- ì „í™”ë²ˆí˜¸ ì…ë ¥ (ìë™ í¬ë§·íŒ…: 010-1234-5678)
- SMS ì¸ì¦ ì½”ë“œ ìš”ì²­ ë²„íŠ¼
- 5ë¶„ ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
- 6ìë¦¬ ì¸ì¦ ì½”ë“œ ì…ë ¥
- ì½”ë“œ ì¬ìš”ì²­ ê¸°ëŠ¥
- ë¡œê·¸ì¸ ì„±ê³µ ì‹œ `is_first_login` ì²´í¬

**UI êµ¬ì„±**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SMS ì•„ì´ì½˜ (80px)      â”‚
â”‚  SMS ì¸ì¦ ë¡œê·¸ì¸        â”‚
â”‚  ì•ˆë‚´ ë©”ì‹œì§€            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì „í™”ë²ˆí˜¸ ì…ë ¥          â”‚
â”‚  [ì¸ì¦ ì½”ë“œ ìš”ì²­]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â± ë‚¨ì€ ì‹œê°„: 04:32    â”‚
â”‚  ì¸ì¦ ì½”ë“œ ì…ë ¥ (6ìë¦¬) â”‚
â”‚  [ë¡œê·¸ì¸]               â”‚
â”‚  [ë‹¤ì‹œ ìš”ì²­í•˜ê¸°]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ (`change_password_screen.dart`)

**ì£¼ìš” ê¸°ëŠ¥**:
- ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
- ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ì˜ë¬¸+ìˆ«ì 8ì ì´ìƒ)
- ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥
- ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦
- ì²« ë¡œê·¸ì¸ ê°•ì œ ë³€ê²½ ëª¨ë“œ (`forceChange: true`)
  - ë’¤ë¡œê°€ê¸° ë§‰ê¸° (`PopScope.canPop: false`)
  - AppBar ìˆ¨ê¹€
  - ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ

**ë¹„ë°€ë²ˆí˜¸ ì •ì±…**:
- ìµœì†Œ 8ì ì´ìƒ
- ì˜ë¬¸ í¬í•¨
- ìˆ«ì í¬í•¨

### React (ê°„í˜¸ì‚¬/ê´€ë¦¬ììš© ì›¹)

#### 1. í™˜ì ë“±ë¡ í˜ì´ì§€ (`PatientRegistration.jsx`)

**ì£¼ìš” ê¸°ëŠ¥**:
- Material-UI ê¸°ë°˜ ë°˜ì‘í˜• í¼
- ì‹¤ì‹œê°„ ì…ë ¥ ê²€ì¦
- ì „í™”ë²ˆí˜¸/ì£¼ë¯¼ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
- ë‹´ë‹¹ ì˜ì‚¬ ì„ íƒ (GET `/api/v1/users/profiles/?role=DOCTOR`)
- ë“±ë¡ ì™„ë£Œ ë‹¤ì´ì–¼ë¡œê·¸

**ì…ë ¥ í•„ë“œ**:

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| last_name | Text | âœ“ | ì„± |
| first_name | Text | âœ“ | ì´ë¦„ |
| ssn | Text | âœ“ | ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (123456-1234567) |
| phone | Text | âœ“ | ì „í™”ë²ˆí˜¸ (010-1234-5678) |
| date_of_birth | Date | âœ“ | ìƒë…„ì›”ì¼ |
| gender | Select | âœ“ | ì„±ë³„ (M/F/O) |
| doctor_id | Select | âœ“ | ë‹´ë‹¹ ì˜ì‚¬ |
| address | Textarea |  | ì£¼ì†Œ |
| email | Email |  | ì´ë©”ì¼ |
| emergency_contact | Text |  | ë¹„ìƒ ì—°ë½ì²˜ |
| insurance_id | Text |  | ê±´ê°•ë³´í—˜ ë²ˆí˜¸ |

**ë“±ë¡ ê²°ê³¼ ë‹¤ì´ì–¼ë¡œê·¸**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ“ í™˜ì ë“±ë¡ ì™„ë£Œ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ í™˜ì ì •ë³´                    â”‚
â”‚  í™˜ì ID: PT-20250106-0001 ğŸ“‹â”‚
â”‚  ì§„ë£Œê¸°ë¡ë²ˆí˜¸: MR-20250106.. ğŸ“‹â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë¡œê·¸ì¸ ì •ë³´ (í™˜ìì—ê²Œ ì•ˆë‚´)  â”‚
â”‚  ë¡œê·¸ì¸ ID: 01012345678 ğŸ“‹   â”‚
â”‚  ì„ì‹œ ë¹„ë°€ë²ˆí˜¸: testpass123 ğŸ“‹â”‚
â”‚                              â”‚
â”‚ âš  ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      [ì¸ì‡„]       [í™•ì¸]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ê°„í˜¸ì‚¬ í™˜ì ë“±ë¡ í…ŒìŠ¤íŠ¸

#### Prerequisites
- ê°„í˜¸ì‚¬ ë˜ëŠ” ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
- ì˜ì‚¬ ê³„ì • ì¡´ì¬

#### í…ŒìŠ¤íŠ¸ ë‹¨ê³„
1. React ì›¹ì•±ì—ì„œ í™˜ì ë“±ë¡ í˜ì´ì§€ ì ‘ì†
2. í™˜ì ì •ë³´ ì…ë ¥:
   - ì´ë¦„: í…ŒìŠ¤íŠ¸ í™˜ì
   - ì£¼ë¯¼ë²ˆí˜¸: 900101-1234567
   - ì „í™”ë²ˆí˜¸: 010-1111-2222
   - ìƒë…„ì›”ì¼: 1990-01-01
   - ì„±ë³„: ë‚¨ì„±
   - ë‹´ë‹¹ ì˜ì‚¬: ì„ íƒ
3. [í™˜ì ë“±ë¡] ë²„íŠ¼ í´ë¦­
4. ê²°ê³¼ ë‹¤ì´ì–¼ë¡œê·¸ í™•ì¸:
   - âœ“ í™˜ì ID (PT-YYYYMMDD-NNNN)
   - âœ“ ì§„ë£Œê¸°ë¡ë²ˆí˜¸ (MR-YYYYMMDD-NNNN)
   - âœ“ ë¡œê·¸ì¸ ID (01011112222)
   - âœ“ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ (testpass123)

**ì˜ˆìƒ ê²°ê³¼**: ì„±ê³µ ë©”ì‹œì§€ ë° ë“±ë¡ ì •ë³´ í‘œì‹œ

### 2. í™˜ì ì²« ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ (ì¼ë°˜ ë¡œê·¸ì¸)

#### í…ŒìŠ¤íŠ¸ ë‹¨ê³„
1. Flutter ì•±ì—ì„œ ë¡œê·¸ì¸ í™”ë©´ ì ‘ì†
2. ì‚¬ìš©ìëª…: `01011112222` (ì „í™”ë²ˆí˜¸)
3. ë¹„ë°€ë²ˆí˜¸: `testpass123`
4. [ë¡œê·¸ì¸] ë²„íŠ¼ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼**: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ìœ¼ë¡œ ìë™ ì´ë™ (ë’¤ë¡œê°€ê¸° ë¶ˆê°€)

### 3. SMS ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

#### í…ŒìŠ¤íŠ¸ ë‹¨ê³„
1. Flutter ì•± ë¡œê·¸ì¸ í™”ë©´ì—ì„œ [SMSë¡œ ë¡œê·¸ì¸] ë²„íŠ¼ í´ë¦­
2. ì „í™”ë²ˆí˜¸ ì…ë ¥: `010-1111-2222`
3. [ì¸ì¦ ì½”ë“œ ìš”ì²­] ë²„íŠ¼ í´ë¦­
4. ì„œë²„ ë¡œê·¸ì—ì„œ ì¸ì¦ ì½”ë“œ í™•ì¸:
   ```
   [SMS] To: 01011112222, Message: [NeuroNova] ì¸ì¦ ì½”ë“œ: 123456
   5ë¶„ ì´ë‚´ì— ì…ë ¥í•´ì£¼ì„¸ìš”.
   ```
5. 6ìë¦¬ ì½”ë“œ ì…ë ¥: `123456`
6. [ë¡œê·¸ì¸] ë²„íŠ¼ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼**:
- `is_first_login: true` â†’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´
- `is_first_login: false` â†’ í™ˆ í™”ë©´

### 4. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í…ŒìŠ¤íŠ¸

#### í…ŒìŠ¤íŠ¸ ë‹¨ê³„
1. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ì—ì„œ ì…ë ¥:
   - ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸: `testpass123`
   - ìƒˆ ë¹„ë°€ë²ˆí˜¸: `NewPass123!`
   - ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸: `NewPass123!`
2. [ë¹„ë°€ë²ˆí˜¸ ë³€ê²½] ë²„íŠ¼ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼**:
- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
- í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™
- `is_first_login` í”Œë˜ê·¸ `false`ë¡œ ë³€ê²½

### 5. ì¬ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í›„)

#### í…ŒìŠ¤íŠ¸ ë‹¨ê³„
1. ë¡œê·¸ì•„ì›ƒ
2. ì‚¬ìš©ìëª…: `01011112222`
3. ë¹„ë°€ë²ˆí˜¸: `NewPass123!`
4. [ë¡œê·¸ì¸] ë²„íŠ¼ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼**: í™ˆ í™”ë©´ìœ¼ë¡œ ë°”ë¡œ ì´ë™ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ í‘œì‹œ ì•ˆí•¨)

---

## ë°°í¬ ê°€ì´ë“œ

### 1. ë°±ì—”ë“œ ë°°í¬

#### Prerequisites
- Python 3.9+
- MySQL ë°ì´í„°ë² ì´ìŠ¤
- Redis (SMS ì½”ë“œ ìºì‹±ìš©)

#### ë‹¨ê³„

1. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •** (`.env`)
   ```bash
   # ì•”í˜¸í™” í‚¤ ìƒì„±
   python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

   # .env íŒŒì¼ì— ì¶”ê°€
   ENCRYPTION_KEY=ìƒì„±ëœ_í‚¤
   ```

2. **ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜**
   ```bash
   cd backend/django_main
   python manage.py migrate users 0004
   python manage.py migrate emr 0002
   ```

3. **í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜** (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì„ ê°€ëŠ¥ì„± ë†’ìŒ)
   ```bash
   pip install cryptography
   ```

4. **SMS ì„œë¹„ìŠ¤ ì—°ë™** (ìš´ì˜ í™˜ê²½)
   - `apps/users/utils.py`ì˜ `send_sms()` í•¨ìˆ˜ ìˆ˜ì •
   - í•œêµ­ SMS ì„œë¹„ìŠ¤ ì„ íƒ:
     - Aligo SMS
     - NHN Cloud SMS
     - AWS SNS

### 2. Flutter ì•± ë°°í¬

#### ë¼ìš°íŒ… ì„¤ì • í•„ìš”

`main.dart` ë˜ëŠ” ë¼ìš°íŒ… íŒŒì¼ì— ë‹¤ìŒ ë¼ìš°íŠ¸ ì¶”ê°€:

```dart
import 'features/auth/sms_login_screen.dart';
import 'features/auth/change_password_screen.dart';

// MaterialAppì˜ routesì— ì¶”ê°€
routes: {
  '/sms-login': (context) => const SmsLoginScreen(),
  '/change-password': (context) {
    final args = ModalRoute.of(context)?.settings.arguments as Map?;
    return ChangePasswordScreen(
      forceChange: args?['forceChange'] ?? false,
    );
  },
  // ... ê¸°ì¡´ ë¼ìš°íŠ¸
},
```

#### ë¹Œë“œ ë° ë°°í¬
```bash
cd frontend/flutter_app
flutter pub get
flutter build apk --release  # Android
flutter build ios --release  # iOS
```

### 3. React ì›¹ ë°°í¬

#### ë¼ìš°íŒ… ì„¤ì • í•„ìš”

`App.jsx` ë˜ëŠ” ë¼ìš°íŒ… íŒŒì¼ì— ë¼ìš°íŠ¸ ì¶”ê°€:

```jsx
import PatientRegistration from './pages/admin/PatientRegistration';

// Routesì— ì¶”ê°€ (React Router ì‚¬ìš© ì‹œ)
<Route path="/admin/patient-registration" element={<PatientRegistration />} />
```

#### ë¹Œë“œ ë° ë°°í¬
```bash
cd frontend/react_web
npm install
npm run build
```

---

## ë‹¤ìŒ ë‹¨ê³„

### 1. ìš´ì˜ í™˜ê²½ ì„¤ì • (ìš°ì„ ìˆœìœ„ ë†’ìŒ)

- [ ] SMS ì„œë¹„ìŠ¤ ì‹¤ì œ ì—°ë™
- [ ] ENCRYPTION_KEY í”„ë¡œë•ì…˜ í‚¤ ìƒì„± ë° ì„¤ì •
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì •ì±… ìˆ˜ë¦½
- [ ] ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ì„¤ì •

### 2. ë³´ì•ˆ ê°•í™”

- [ ] SMS ì „ì†¡ Rate Limiting (1ë¶„ì— 3íšŒ ì œí•œ)
- [ ] ì£¼ë¯¼ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ (ì¡°íšŒ ì‹œ \*\*\*\*\*\*-\*\*\*\*567)
- [ ] í™˜ì ë“±ë¡/SSN ì ‘ê·¼ ê°ì‚¬ ë¡œê·¸
- [ ] ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê°•í™” (íŠ¹ìˆ˜ë¬¸ì í•„ìˆ˜ ë“±)

### 3. ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

- [ ] SMS ë¡œê·¸ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ë‹¤êµ­ì–´ ì§€ì›
- [ ] ë¹„ë°€ë²ˆí˜¸ ê°•ë„ í‘œì‹œ ì¸ë””ì¼€ì´í„°
- [ ] í™˜ì ë“±ë¡ ì„±ê³µ ì‹œ ì´ë©”ì¼ ì•Œë¦¼
- [ ] ê°„í˜¸ì‚¬ìš© í™˜ì ê²€ìƒ‰ ê¸°ëŠ¥

### 4. ì¶”ê°€ ê¸°ëŠ¥

- [ ] í™˜ì ë“±ë¡ ì´ë ¥ ì¡°íšŒ
- [ ] í™˜ì ì •ë³´ ìˆ˜ì • (ê°„í˜¸ì‚¬/ê´€ë¦¬ì)
- [ ] ë‹´ë‹¹ ì˜ì‚¬ ë³€ê²½ ê¸°ëŠ¥
- [ ] í™˜ì ë“±ë¡ í†µê³„ ëŒ€ì‹œë³´ë“œ

### 5. í…ŒìŠ¤íŠ¸ ë° ë¬¸ì„œí™”

- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± (Django)
- [ ] ìœ„ì ¯ í…ŒìŠ¤íŠ¸ ì‘ì„± (Flutter)
- [ ] E2E í…ŒìŠ¤íŠ¸ ì‘ì„±
- [ ] ì‚¬ìš©ì ë§¤ë‰´ì–¼ ì‘ì„± (ê°„í˜¸ì‚¬ìš©)
- [ ] í™˜ì ì•± ì‚¬ìš© ì•ˆë‚´ë¬¸ ì‘ì„±

---

## íŒŒì¼ ë³€ê²½ ì´ë ¥

### ì‹ ê·œ ìƒì„± íŒŒì¼

#### ë°±ì—”ë“œ
- `backend/django_main/apps/users/utils.py` (270 lines)
- `backend/django_main/apps/users/migrations/0004_userprofile_is_first_login.py`
- `backend/django_main/apps/emr/migrations/0002_patient_medical_record_number_patient_ssn_encrypted.py`

#### Flutter
- `frontend/flutter_app/lib/features/auth/sms_login_screen.dart` (420 lines)
- `frontend/flutter_app/lib/features/auth/change_password_screen.dart` (390 lines)

#### React
- `frontend/react_web/src/pages/admin/PatientRegistration.jsx` (550 lines)

### ìˆ˜ì •ëœ íŒŒì¼

#### ë°±ì—”ë“œ
- `backend/django_main/apps/users/models.py` (+8 lines)
- `backend/django_main/apps/emr/models.py` (+18 lines)
- `backend/django_main/apps/users/serializers.py` (+143 lines)
- `backend/django_main/apps/users/views.py` (+171 lines)
- `backend/django_main/apps/users/permissions.py` (+13 lines)
- `backend/django_main/apps/users/urls.py` (+3 lines)
- `backend/django_main/neuronova/settings.py` (+7 lines)
- `backend/django_main/.env.example` (+4 lines)

#### Flutter
- `frontend/flutter_app/lib/data/repositories/auth_repository.dart` (+154 lines)
- `frontend/flutter_app/lib/features/auth/login_screen.dart` (+36 lines)

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: SMS ì½”ë“œê°€ ì „ì†¡ë˜ì§€ ì•ŠìŒ (ê°œë°œ í™˜ê²½)
**ì›ì¸**: `send_sms()` í•¨ìˆ˜ê°€ í”Œë ˆì´ìŠ¤í™€ë”
**í•´ê²°**: ì„œë²„ ë¡œê·¸ì—ì„œ ì½”ë“œ í™•ì¸
```bash
tail -f backend/django_main/logs/django.log | grep "SMS code sent"
```

### ë¬¸ì œ 2: ì•”í˜¸í™” í‚¤ ì˜¤ë¥˜
**ì›ì¸**: `ENCRYPTION_KEY` í™˜ê²½ ë³€ìˆ˜ ë¯¸ì„¤ì •
**í•´ê²°**: `.env` íŒŒì¼ì— í‚¤ ì¶”ê°€
```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

### ë¬¸ì œ 3: is_first_loginì´ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ
**ì›ì¸**: ì¼ë°˜ ë¡œê·¸ì¸ ì‹œ `is_first_login` í”Œë˜ê·¸ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŒ
**í•´ê²°**: AuthRepositoryì˜ `login()` ë©”ì„œë“œì—ì„œë„ í”Œë˜ê·¸ ì €ì¥ í•„ìš” (í˜„ì¬ëŠ” SMS ë¡œê·¸ì¸ë§Œ ì§€ì›)

---

## ì°¸ê³  ìë£Œ

- [Django Password Validation](https://docs.djangoproject.com/en/stable/topics/auth/passwords/)
- [Cryptography Fernet](https://cryptography.io/en/latest/fernet/)
- [Flutter Form Validation](https://docs.flutter.dev/cookbook/forms/validation)
- [Material-UI React Components](https://mui.com/material-ui/getting-started/)

---

**ë³´ê³ ì„œ ì¢…ë£Œ**

êµ¬í˜„ ì™„ë£Œì¼: 2025-12-06
ì‘ì„±ì: Claude Code
ë²„ì „: 1.0
