# NeuroNova 백업 및 복원 가이드

## 목차
1. [개요](#개요)
2. [백업 시스템 설치](#백업-시스템-설치)
3. [자동 백업](#자동-백업)
4. [수동 백업](#수동-백업)
5. [데이터 복원](#데이터-복원)
6. [백업 전략](#백업-전략)
7. [트러블슈팅](#트러블슈팅)

---

## 개요

NeuroNova 백업 시스템은 데이터 손실을 방지하고 재해 복구를 위한 자동화된 백업 솔루션을 제공합니다.

### 백업 대상
1. **데이터베이스** (MySQL)
   - 환자 정보
   - 진료 기록
   - 사용자 계정
   - 예약 정보
   - 보관 기간: 30일

2. **미디어 파일**
   - DICOM 이미지
   - 업로드된 파일
   - 환자 문서
   - 보관 기간: 90일

### 백업 스케줄
- **데이터베이스**: 매일 새벽 02:00
- **미디어 파일**: 매일 새벽 03:00

---

## 백업 시스템 설치

### 원클릭 설치

```bash
cd ~/NeuroNova/deploy/backup
sudo bash setup_backup.sh
```

이 스크립트는 자동으로:
1. 백업 디렉토리 생성
2. 백업 스크립트 설치
3. Cron 작업 등록
4. 테스트 백업 실행

### 수동 설치

#### 1. 백업 디렉토리 생성
```bash
sudo mkdir -p /var/backups/neuronova/database
sudo mkdir -p /var/backups/neuronova/media
sudo chmod 755 /var/backups/neuronova
```

#### 2. 스크립트 복사
```bash
cd ~/NeuroNova/deploy/backup
sudo cp backup_database.sh /usr/local/bin/neuronova-backup-db
sudo cp backup_media.sh /usr/local/bin/neuronova-backup-media
sudo cp restore_database.sh /usr/local/bin/neuronova-restore-db

sudo chmod +x /usr/local/bin/neuronova-backup-*
sudo chmod +x /usr/local/bin/neuronova-restore-*
```

#### 3. Cron 작업 등록
```bash
crontab -e
```

다음 라인 추가:
```cron
# NeuroNova 자동 백업
0 2 * * * /usr/local/bin/neuronova-backup-db >> /var/log/neuronova/backup.log 2>&1
0 3 * * * /usr/local/bin/neuronova-backup-media >> /var/log/neuronova/backup.log 2>&1
```

---

## 자동 백업

### Cron 작업 확인

```bash
# Cron 작업 목록 확인
crontab -l

# 출력 예시:
# 0 2 * * * /usr/local/bin/neuronova-backup-db >> /var/log/neuronova/backup.log 2>&1
# 0 3 * * * /usr/local/bin/neuronova-backup-media >> /var/log/neuronova/backup.log 2>&1
```

### 백업 로그 확인

```bash
# 실시간 로그
tail -f /var/log/neuronova/backup.log

# 최근 50줄
tail -50 /var/log/neuronova/backup.log

# 오늘 로그만
grep "$(date +%Y-%m-%d)" /var/log/neuronova/backup.log
```

**로그 예시:**
```
[2025-12-06 02:00:01] INFO: =========================================
[2025-12-06 02:00:01] INFO: 데이터베이스 백업 시작
[2025-12-06 02:00:01] INFO: =========================================
[2025-12-06 02:00:01] INFO: 백업 대상: neuronova@localhost
[2025-12-06 02:00:01] INFO: MySQL 덤프 중...
[2025-12-06 02:00:15] SUCCESS: MySQL 덤프 완료: neuronova_db_20251206_020001.sql
[2025-12-06 02:00:15] INFO: 백업 파일 압축 중...
[2025-12-06 02:00:18] SUCCESS: 압축 완료: neuronova_db_20251206_020001.sql.gz
[2025-12-06 02:00:18] INFO: 백업 파일 크기: 45M
[2025-12-06 02:00:18] INFO: 오래된 백업 파일 정리 중 (30일 이상)...
[2025-12-06 02:00:18] INFO: 삭제할 오래된 백업 파일 없음
[2025-12-06 02:00:18] INFO: 현재 백업 파일 수: 15개
[2025-12-06 02:00:18] INFO: 백업 디렉토리 디스크 사용량: 45%
[2025-12-06 02:00:18] INFO: =========================================
[2025-12-06 02:00:18] SUCCESS: 데이터베이스 백업 완료!
[2025-12-06 02:00:18] INFO: 백업 위치: /var/backups/neuronova/database/neuronova_db_20251206_020001.sql.gz
[2025-12-06 02:00:18] INFO: =========================================
```

### 백업 파일 목록 확인

```bash
# 데이터베이스 백업
ls -lht /var/backups/neuronova/database/

# 미디어 파일 백업
ls -lht /var/backups/neuronova/media/

# 백업 파일 크기 확인
du -sh /var/backups/neuronova/database/
du -sh /var/backups/neuronova/media/
```

---

## 수동 백업

자동 백업 외에도 언제든 수동으로 백업을 실행할 수 있습니다.

### 데이터베이스 백업

```bash
sudo neuronova-backup-db
```

### 미디어 파일 백업

```bash
sudo neuronova-backup-media
```

### 배포 전 백업 (권장)

중요한 업데이트나 마이그레이션 전에 반드시 백업하세요:

```bash
# 전체 백업
sudo neuronova-backup-db
sudo neuronova-backup-media

# 백업 완료 확인
ls -lht /var/backups/neuronova/database/ | head -1
ls -lht /var/backups/neuronova/media/ | head -1
```

---

## 데이터 복원

### 데이터베이스 복원

#### 1. 사용 가능한 백업 확인
```bash
ls -lht /var/backups/neuronova/database/
```

출력 예시:
```
-rw-r--r-- 1 user user  45M 12월  6 02:00 neuronova_db_20251206_020001.sql.gz
-rw-r--r-- 1 user user  44M 12월  5 02:00 neuronova_db_20251205_020001.sql.gz
-rw-r--r-- 1 user user  43M 12월  4 02:00 neuronova_db_20251204_020001.sql.gz
```

#### 2. 복원 실행
```bash
sudo neuronova-restore-db neuronova_db_20251206_020001.sql.gz
```

#### 3. 확인 프롬프트
```
⚠️  경고: 이 작업은 현재 데이터베이스를 백업 시점으로 되돌립니다.
데이터베이스: neuronova
백업 파일: neuronova_db_20251206_020001.sql.gz

계속하시겠습니까? (yes/no): yes
```

#### 4. 복원 프로세스
1. 현재 DB를 안전 백업으로 저장
2. 백업 파일 압축 해제
3. 데이터베이스 복원
4. 임시 파일 삭제

#### 5. 복원 완료 확인
```bash
# Django 서비스 재시작
sudo systemctl restart gunicorn_django

# 헬스 체크
curl http://localhost:8000/api/health/
```

### 미디어 파일 복원

#### 1. 백업 파일 확인
```bash
ls -lht /var/backups/neuronova/media/
```

#### 2. 현재 미디어 디렉토리 백업 (안전장치)
```bash
sudo mv ~/NeuroNova/backend/django_main/media \
        ~/NeuroNova/backend/django_main/media.bak.$(date +%Y%m%d_%H%M%S)
```

#### 3. 백업 파일 압축 해제 및 복원
```bash
cd ~/NeuroNova/backend/django_main
sudo tar -xzf /var/backups/neuronova/media/neuronova_media_20251206_030001.tar.gz
```

#### 4. 권한 설정
```bash
sudo chown -R www-data:www-data ~/NeuroNova/backend/django_main/media
sudo chmod -R 755 ~/NeuroNova/backend/django_main/media
```

### 특정 시점으로 복원 (Point-in-Time Recovery)

특정 날짜/시간의 데이터로 복원:

```bash
# 1. 복원하고 싶은 백업 파일 찾기
ls -lht /var/backups/neuronova/database/ | grep "20251205"

# 2. 해당 백업으로 복원
sudo neuronova-restore-db neuronova_db_20251205_020001.sql.gz
```

---

## 백업 전략

### 3-2-1 백업 규칙

권장 백업 전략:
- **3개 복사본**: 원본 + 백업 2개
- **2가지 매체**: 로컬 서버 + 외부 스토리지
- **1개 오프사이트**: 다른 물리적 위치

### 로컬 백업 (현재 구현)

✅ **구현됨:**
- 매일 자동 백업
- 압축 저장 (gzip)
- 자동 정리 (30일/90일)
- 로그 기록

### 원격 백업 (권장 추가)

원격 스토리지로 백업 전송:

#### AWS S3 백업
```bash
# AWS CLI 설치
sudo apt-get install -y awscli

# 자격증명 설정
aws configure

# S3로 백업 업로드
aws s3 sync /var/backups/neuronova/ s3://your-bucket-name/neuronova-backups/
```

#### Google Drive 백업
```bash
# rclone 설치
sudo apt-get install -y rclone

# Google Drive 설정
rclone config

# 백업 업로드
rclone sync /var/backups/neuronova/ gdrive:NeuroNova-Backups/
```

#### 원격 서버 백업 (rsync)
```bash
# rsync로 다른 서버에 백업
rsync -avz /var/backups/neuronova/ user@backup-server:/backups/neuronova/
```

### 백업 자동화 개선

Cron에 원격 백업 추가:
```cron
# 매일 새벽 4시: 원격 백업
0 4 * * * aws s3 sync /var/backups/neuronova/ s3://your-bucket/neuronova/ >> /var/log/neuronova/backup.log 2>&1
```

### 백업 모니터링

백업 실패 시 알림 설정:

```bash
# 백업 후 결과 확인 및 알림 스크립트
#!/bin/bash
if grep -q "ERROR" /var/log/neuronova/backup.log; then
    echo "백업 실패 발생!" | mail -s "[ALERT] NeuroNova 백업 실패" admin@example.com
fi
```

---

## 트러블슈팅

### 1. 백업 실패: 디스크 공간 부족

**증상:**
```
ERROR: 백업 파일 압축 실패
No space left on device
```

**해결:**
```bash
# 디스크 사용량 확인
df -h

# 오래된 백업 수동 삭제
sudo find /var/backups/neuronova/database/ -mtime +30 -delete
sudo find /var/backups/neuronova/media/ -mtime +90 -delete

# 또는 백업 디렉토리를 더 큰 디스크로 이동
sudo mv /var/backups/neuronova /mnt/large-disk/backups/neuronova
sudo ln -s /mnt/large-disk/backups/neuronova /var/backups/neuronova
```

### 2. 복원 실패: 데이터베이스 연결 오류

**증상:**
```
ERROR: Access denied for user 'root'@'localhost'
```

**해결:**
```bash
# .env 파일 확인
cat ~/NeuroNova/backend/django_main/.env | grep DB_

# MySQL 로그인 테스트
mysql -u $DB_USER -p$DB_PASSWORD -h $DB_HOST

# 비밀번호가 틀린 경우 .env 수정
nano ~/NeuroNova/backend/django_main/.env
```

### 3. Cron 작업이 실행되지 않음

**확인:**
```bash
# Cron 서비스 상태
sudo systemctl status cron

# Cron 로그
grep CRON /var/log/syslog

# 환경 변수 문제 확인
crontab -l
```

**해결:**
```bash
# Cron 서비스 재시작
sudo systemctl restart cron

# 절대 경로 사용
crontab -e
# /usr/local/bin/neuronova-backup-db 대신 전체 경로 사용
```

### 4. 백업 파일이 너무 큼

**증상:**
```
백업 파일 크기: 5.0G
```

**해결:**
```bash
# 데이터베이스 정리
# 오래된 로그 삭제
mysql -u root -p neuronova -e "DELETE FROM django_session WHERE expire_date < NOW();"

# 오래된 알림 삭제 (90일 이상)
mysql -u root -p neuronova -e "DELETE FROM notifications WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);"

# 백업 후 즉시 원격 전송 및 로컬 삭제
aws s3 cp /var/backups/neuronova/database/latest.sql.gz s3://bucket/ && \
  rm /var/backups/neuronova/database/latest.sql.gz
```

### 5. 복원 후 애플리케이션 오류

**증상:**
```
500 Internal Server Error
Migration conflicts detected
```

**해결:**
```bash
# Django 마이그레이션 상태 확인
cd ~/NeuroNova/backend/django_main
source venv/bin/activate
python manage.py showmigrations

# 마이그레이션 재실행
python manage.py migrate --fake-initial

# 서비스 재시작
sudo systemctl restart gunicorn_django
```

### 6. 미디어 파일 권한 문제

**증상:**
```
Permission denied: '/path/to/media/file.jpg'
```

**해결:**
```bash
# 미디어 디렉토리 권한 수정
sudo chown -R www-data:www-data ~/NeuroNova/backend/django_main/media
sudo chmod -R 755 ~/NeuroNova/backend/django_main/media

# Nginx 재시작
sudo systemctl restart nginx
```

---

## 재해 복구 시나리오

### 시나리오 1: 서버 전체 장애

#### 1. 새 서버 준비
```bash
# 기본 소프트웨어 설치
sudo apt-get update
sudo apt-get install -y nginx mysql-server python3
```

#### 2. 프로젝트 클론
```bash
git clone https://github.com/your-org/NeuroNova.git
cd NeuroNova
```

#### 3. 백업 파일 복원
```bash
# 원격 백업에서 다운로드
aws s3 sync s3://your-bucket/neuronova/ /var/backups/neuronova/

# 최신 백업 복원
sudo neuronova-restore-db <latest-backup-file>
```

#### 4. 배포
```bash
# 배포 가이드에 따라 설정
# ...
```

### 시나리오 2: 데이터베이스 손상

#### 1. 즉시 서비스 중지
```bash
sudo systemctl stop gunicorn_django
```

#### 2. 최신 백업 확인
```bash
ls -lt /var/backups/neuronova/database/ | head -1
```

#### 3. 복원
```bash
sudo neuronova-restore-db <backup-file>
```

#### 4. 검증 및 재시작
```bash
mysql -u root -p neuronova -e "SELECT COUNT(*) FROM auth_user;"
sudo systemctl start gunicorn_django
```

---

## 백업 체크리스트

### 일일 체크
- [ ] 백업 로그 확인 (오류 없는지)
- [ ] 백업 파일 생성 확인

### 주간 체크
- [ ] 백업 파일 크기 추세 확인
- [ ] 디스크 공간 확인
- [ ] 테스트 복원 수행

### 월간 체크
- [ ] 원격 백업 상태 확인
- [ ] 재해 복구 계획 검토
- [ ] 백업 보관 정책 검토

---

**문서 버전**: 1.0
**최종 수정일**: 2025-12-06
**작성자**: NeuroNova 개발팀
