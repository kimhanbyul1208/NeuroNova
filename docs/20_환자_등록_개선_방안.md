# 환자 등록 프로세스 개선 방안

## 목차
1. [현재 문제점](#1-현재-문제점)
2. [개선된 흐름](#2-개선된-흐름)
3. [구현 방안](#3-구현-방안)
4. [API 명세](#4-api-명세)
5. [보안 고려사항](#5-보안-고려사항)

---

## 1. 현재 문제점

### 1.1 기존 환자 회원가입 흐름의 문제
```python
# 현재: 환자가 직접 회원가입 시 Patient 레코드 자동 생성
if role == 'PATIENT':
    Patient.objects.create(
        user=user,
        pid=auto_generated_pid,  # 자동 생성
        date_of_birth=datetime.date(2000, 1, 1),  # 기본값!
        gender=Gender.OTHER,  # 기본값!
        doctor=None  # 담당 의사 없음!
    )
```

**문제점**:
- ❌ 간호사의 검증 절차 없음
- ❌ 환자 정보가 정확하지 않음 (기본값 사용)
- ❌ 담당 의사가 지정되지 않음
- ❌ 병원 등록번호 없음

---

## 2. 개선된 흐름

### 전체 프로세스
```
[간호사] → [환자 정보 등록] → [SMS 발송] → [환자] → [SMS 인증] → [자동 로그인]
```

### 2.1 간호사 작업 (병원 내)

#### Step 1: 환자 정보 수집
- ✅ 이름 (실명)
- ✅ 주민등록번호 (본인 확인)
- ✅ 전화번호 (SMS 인증용)
- ✅ 주소
- ✅ 생년월일
- ✅ 성별
- ✅ 담당 의사 지정

#### Step 2: 시스템 등록
```python
# 간호사가 React Admin 페이지에서 환자 정보 입력
POST /api/v1/nurses/register-patient/

{
  "first_name": "길동",
  "last_name": "홍",
  "ssn": "900101-1234567",  # 주민등록번호 (암호화 저장)
  "phone": "01012345678",   # 전화번호 (하이픈 제거)
  "address": "서울시 강남구...",
  "date_of_birth": "1990-01-01",
  "gender": "M",
  "doctor_id": 5,  # 담당 의사 ID
  "notes": "초진 환자"
}
```

#### Step 3: 자동 처리
시스템이 자동으로:
1. **병원 등록번호 발급**: `MR-20251206-0001`
2. **환자 고유번호 생성**: `PT-20251206-0001`
3. **User 계정 자동 생성**:
   - username: 전화번호 (01012345678)
   - password: `testpass123` (초기 비밀번호)
   - is_active: True
4. **Patient 레코드 생성**
5. **SMS 발송**: "병원 등록이 완료되었습니다. 앱에서 01012345678로 로그인하세요."

---

### 2.2 환자 작업 (모바일 앱)

#### Step 1: 앱 설치 및 실행
- Flutter 앱 다운로드

#### Step 2: 로그인 화면
```dart
// 회원가입 버튼 없음!
// 로그인만 가능

TextField(
  label: "전화번호",
  hint: "010-1234-5678"
)

TextField(
  label: "비밀번호",
  hint: "초기 비밀번호: testpass123",
  obscureText: true
)
```

#### Step 3: SMS 인증 (선택적)
```dart
// Option 1: 일반 로그인
POST /api/v1/users/login/
{
  "username": "01012345678",
  "password": "testpass123"
}

// Option 2: SMS 인증 로그인 (더 안전)
POST /api/v1/users/sms-login/
{
  "phone": "01012345678",
  "verification_code": "123456"  // SMS로 받은 코드
}
```

#### Step 4: 최초 로그인 시 비밀번호 변경 강제
```dart
if (user.isFirstLogin || user.password == 'testpass123') {
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => ChangePasswordScreen(
        forceChange: true
      )
    )
  );
}
```

---

## 3. 구현 방안

### 3.1 Backend (Django)

#### 새로운 Serializer: NursePatientRegistrationSerializer

```python
# apps/users/serializers.py

class NursePatientRegistrationSerializer(serializers.Serializer):
    """
    간호사가 환자를 등록하는 Serializer.
    User와 Patient를 자동 생성하고 SMS 발송.
    """
    first_name = serializers.CharField(max_length=100)
    last_name = serializers.CharField(max_length=100)
    ssn = serializers.CharField(
        max_length=14,
        help_text="주민등록번호 (예: 900101-1234567)"
    )
    phone = serializers.CharField(
        max_length=20,
        help_text="전화번호 (예: 010-1234-5678)"
    )
    address = serializers.CharField(required=False, allow_blank=True)
    date_of_birth = serializers.DateField()
    gender = serializers.ChoiceField(choices=Gender.CHOICES)
    doctor_id = serializers.IntegerField(help_text="담당 의사 ID")
    emergency_contact = serializers.CharField(required=False, allow_blank=True)
    notes = serializers.CharField(required=False, allow_blank=True)

    def validate_phone(self, value):
        """전화번호 형식 검증 및 정규화."""
        # 하이픈 제거
        phone = value.replace('-', '').replace(' ', '')

        # 한국 휴대폰 번호 형식 검증
        import re
        if not re.match(r'^01[0-9]{8,9}$', phone):
            raise serializers.ValidationError(
                "올바른 휴대폰 번호 형식이 아닙니다. (예: 010-1234-5678)"
            )

        # 중복 확인
        if User.objects.filter(username=phone).exists():
            raise serializers.ValidationError(
                "이미 등록된 전화번호입니다."
            )

        return phone

    def validate_ssn(self, value):
        """주민등록번호 형식 검증."""
        import re
        ssn = value.replace('-', '')

        if not re.match(r'^\d{13}$', ssn):
            raise serializers.ValidationError(
                "올바른 주민등록번호 형식이 아닙니다."
            )

        return ssn

    def validate_doctor_id(self, value):
        """담당 의사 존재 여부 확인."""
        from django.contrib.auth.models import User
        try:
            doctor = User.objects.get(id=value)
            if not hasattr(doctor, 'profile') or doctor.profile.role != 'DOCTOR':
                raise serializers.ValidationError("유효한 의사가 아닙니다.")
        except User.DoesNotExist:
            raise serializers.ValidationError("존재하지 않는 의사입니다.")

        return value

    def create(self, validated_data):
        """환자 정보로 User와 Patient 자동 생성."""
        from django.contrib.auth.models import User
        from apps.emr.models import Patient
        from apps.users.models import UserProfile
        from config.constants import UserRole, ApprovalStatus
        import datetime

        # 전화번호를 username으로 사용
        phone = validated_data['phone']

        # User 생성
        user = User.objects.create_user(
            username=phone,  # 전화번호가 ID
            password='testpass123',  # 초기 비밀번호
            first_name=validated_data['first_name'],
            last_name=validated_data['last_name'],
            email=f"{phone}@temp.neuronova.com",  # 임시 이메일
            is_active=True
        )

        # UserProfile 생성
        profile = UserProfile.objects.create(
            user=user,
            role=UserRole.PATIENT,
            phone_number=phone,
            approval_status=ApprovalStatus.APPROVED,
            is_first_login=True  # 최초 로그인 플래그
        )

        # 병원 등록번호 생성
        from apps.emr.models import Patient
        today = datetime.date.today()
        patient_count = Patient.objects.filter(
            created_at__date=today
        ).count()
        medical_record_number = f"MR-{today.strftime('%Y%m%d')}-{patient_count + 1:04d}"

        # 환자 고유번호 생성
        pid = f"PT-{today.strftime('%Y%m%d')}-{user.id:04d}"

        # 담당 의사 조회
        doctor = User.objects.get(id=validated_data['doctor_id'])

        # Patient 레코드 생성
        patient = Patient.objects.create(
            user=user,
            pid=pid,
            first_name=validated_data['first_name'],
            last_name=validated_data['last_name'],
            phone=phone,
            email=user.email,
            date_of_birth=validated_data['date_of_birth'],
            gender=validated_data['gender'],
            address=validated_data.get('address', ''),
            emergency_contact=validated_data.get('emergency_contact', ''),
            doctor=doctor,  # 담당 의사 지정
            # 주민등록번호는 암호화하여 별도 필드에 저장 (추가 필요)
        )

        # PatientDoctor 관계 생성
        from apps.custom.models import PatientDoctor
        PatientDoctor.objects.create(
            patient=patient,
            doctor=doctor.doctor,  # Doctor 모델
            is_primary=True,
            assigned_date=today
        )

        # SMS 발송
        self._send_registration_sms(phone, pid)

        return {
            'user': user,
            'patient': patient,
            'medical_record_number': medical_record_number,
            'initial_password': 'testpass123'
        }

    def _send_registration_sms(self, phone, pid):
        """환자 등록 완료 SMS 발송."""
        from apps.core.services.notification_service import NotificationService

        message = (
            f"[NeuroNova] 병원 등록이 완료되었습니다.\n"
            f"환자번호: {pid}\n"
            f"앱에서 {phone} / testpass123로 로그인하세요.\n"
            f"최초 로그인 시 비밀번호를 변경해주세요."
        )

        NotificationService.send_sms(phone, message)
```

#### 새로운 ViewSet: NursePatientViewSet

```python
# apps/users/views.py

class NursePatientViewSet(viewsets.ViewSet):
    """
    간호사가 환자를 등록하는 ViewSet.
    """
    permission_classes = [IsAuthenticated]

    def get_permissions(self):
        """간호사와 관리자만 접근 가능."""
        from apps.custom.permissions import IsNurseOrAdmin
        return [IsAuthenticated(), IsNurseOrAdmin()]

    @action(detail=False, methods=['post'])
    def register_patient(self, request):
        """
        환자 정보를 등록하고 User/Patient 자동 생성.

        POST /api/v1/nurses/register-patient/
        """
        serializer = NursePatientRegistrationSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        result = serializer.save()

        return Response({
            'message': '환자가 성공적으로 등록되었습니다.',
            'patient_id': result['patient'].id,
            'pid': result['patient'].pid,
            'medical_record_number': result['medical_record_number'],
            'phone': result['patient'].phone,
            'initial_password': result['initial_password'],
            'sms_sent': True
        }, status=status.HTTP_201_CREATED)

    @action(detail=False, methods=['get'])
    def pending_patients(self, request):
        """
        등록되었지만 아직 로그인하지 않은 환자 목록.

        GET /api/v1/nurses/pending-patients/
        """
        from apps.emr.models import Patient
        from apps.users.models import UserProfile

        pending_patients = Patient.objects.filter(
            user__profile__is_first_login=True,
            user__last_login__isnull=True
        ).select_related('user', 'doctor')

        return Response({
            'count': pending_patients.count(),
            'patients': [
                {
                    'id': p.id,
                    'pid': p.pid,
                    'name': p.full_name,
                    'phone': p.phone,
                    'doctor': p.doctor.get_full_name() if p.doctor else None,
                    'registered_at': p.created_at
                }
                for p in pending_patients
            ]
        })
```

#### SMS 로그인 API

```python
# apps/users/views.py

class SMSLoginView(APIView):
    """
    SMS 인증 코드로 로그인.
    """
    permission_classes = [AllowAny]

    def post(self, request):
        """
        POST /api/v1/users/sms-login/
        {
            "phone": "01012345678",
            "verification_code": "123456"
        }
        """
        phone = request.data.get('phone', '').replace('-', '').replace(' ', '')
        code = request.data.get('verification_code')

        # SMS 인증 코드 검증
        from apps.core.services.sms_service import SMSService
        if not SMSService.verify_code(phone, code):
            return Response(
                {'error': '인증 코드가 올바르지 않습니다.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        # 사용자 조회
        try:
            user = User.objects.get(username=phone)
        except User.DoesNotExist:
            return Response(
                {'error': '등록되지 않은 전화번호입니다.'},
                status=status.HTTP_404_NOT_FOUND
            )

        # JWT 토큰 발급
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(user)

        return Response({
            'access': str(refresh.access_token),
            'refresh': str(refresh),
            'user': {
                'id': user.id,
                'username': user.username,
                'name': user.get_full_name(),
                'is_first_login': user.profile.is_first_login
            }
        })
```

---

### 3.2 Frontend (React Admin - 간호사용)

#### 환자 등록 화면

```jsx
// src/pages/nurse/PatientRegistrationPage.jsx

import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { apiClient } from '../../api/client';

const PatientRegistrationPage = () => {
  const { register, handleSubmit, formState: { errors } } = useForm();
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);

  const onSubmit = async (data) => {
    setLoading(true);
    try {
      const response = await apiClient.post('/api/v1/nurses/register-patient/', data);
      setResult(response.data);
      alert('환자 등록이 완료되었습니다. SMS가 발송되었습니다.');
    } catch (error) {
      alert('등록 실패: ' + error.response?.data?.error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="patient-registration">
      <h2>신규 환자 등록</h2>

      <form onSubmit={handleSubmit(onSubmit)}>
        <div className="form-group">
          <label>성</label>
          <input {...register('last_name', { required: true })} />
          {errors.last_name && <span className="error">필수 입력</span>}
        </div>

        <div className="form-group">
          <label>이름</label>
          <input {...register('first_name', { required: true })} />
          {errors.first_name && <span className="error">필수 입력</span>}
        </div>

        <div className="form-group">
          <label>주민등록번호</label>
          <input
            {...register('ssn', {
              required: true,
              pattern: /^\d{6}-\d{7}$/
            })}
            placeholder="900101-1234567"
          />
          {errors.ssn && <span className="error">올바른 형식으로 입력하세요</span>}
        </div>

        <div className="form-group">
          <label>전화번호</label>
          <input
            {...register('phone', {
              required: true,
              pattern: /^01[0-9]-\d{3,4}-\d{4}$/
            })}
            placeholder="010-1234-5678"
          />
          {errors.phone && <span className="error">올바른 형식으로 입력하세요</span>}
        </div>

        <div className="form-group">
          <label>생년월일</label>
          <input type="date" {...register('date_of_birth', { required: true })} />
        </div>

        <div className="form-group">
          <label>성별</label>
          <select {...register('gender', { required: true })}>
            <option value="">선택</option>
            <option value="M">남성</option>
            <option value="F">여성</option>
          </select>
        </div>

        <div className="form-group">
          <label>주소</label>
          <textarea {...register('address')} />
        </div>

        <div className="form-group">
          <label>담당 의사</label>
          <select {...register('doctor_id', { required: true })}>
            {/* 의사 목록 로드 */}
          </select>
        </div>

        <div className="form-group">
          <label>비상 연락처</label>
          <input {...register('emergency_contact')} placeholder="010-9876-5432" />
        </div>

        <div className="form-group">
          <label>메모</label>
          <textarea {...register('notes')} placeholder="초진 환자, 특이사항 등" />
        </div>

        <button type="submit" disabled={loading}>
          {loading ? '등록 중...' : '환자 등록'}
        </button>
      </form>

      {result && (
        <div className="result-box">
          <h3>등록 완료</h3>
          <p><strong>환자번호:</strong> {result.pid}</p>
          <p><strong>병원등록번호:</strong> {result.medical_record_number}</p>
          <p><strong>전화번호:</strong> {result.phone}</p>
          <p><strong>초기 비밀번호:</strong> {result.initial_password}</p>
          <p className="success">SMS가 발송되었습니다.</p>
        </div>
      )}
    </div>
  );
};

export default PatientRegistrationPage;
```

---

### 3.3 Frontend (Flutter - 환자용)

#### 로그인 화면 (회원가입 버튼 제거)

```dart
// lib/features/auth/login_screen.dart

class LoginScreen extends StatefulWidget {
  @override
  _LoginScreenState createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _phoneController = TextEditingController();
  final _passwordController = TextEditingController();
  final _authRepo = AuthRepository();
  bool _isLoading = false;

  Future<void> _login() async {
    setState(() => _isLoading = true);

    try {
      final user = await _authRepo.login(
        _phoneController.text.replaceAll(RegExp(r'[^0-9]'), ''),
        _passwordController.text,
      );

      // 최초 로그인 확인
      if (user['is_first_login'] == true) {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(
            builder: (context) => ChangePasswordScreen(forceChange: true),
          ),
        );
      } else {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (context) => PatientMainPage()),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('로그인 실패: $e')),
      );
    } finally {
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Padding(
        padding: EdgeInsets.all(24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              'NeuroNova',
              style: TextStyle(fontSize: 32, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 48),

            // 전화번호 입력
            TextField(
              controller: _phoneController,
              decoration: InputDecoration(
                labelText: '전화번호',
                hintText: '010-1234-5678',
                prefixIcon: Icon(Icons.phone),
              ),
              keyboardType: TextInputType.phone,
            ),
            SizedBox(height: 16),

            // 비밀번호 입력
            TextField(
              controller: _passwordController,
              decoration: InputDecoration(
                labelText: '비밀번호',
                hintText: '초기 비밀번호: testpass123',
                prefixIcon: Icon(Icons.lock),
              ),
              obscureText: true,
            ),
            SizedBox(height: 24),

            // 로그인 버튼
            ElevatedButton(
              onPressed: _isLoading ? null : _login,
              style: ElevatedButton.styleFrom(
                minimumSize: Size(double.infinity, 50),
              ),
              child: _isLoading
                  ? CircularProgressIndicator()
                  : Text('로그인'),
            ),
            SizedBox(height: 16),

            // SMS 로그인 버튼
            TextButton(
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => SMSLoginScreen(),
                  ),
                );
              },
              child: Text('SMS 인증으로 로그인'),
            ),

            SizedBox(height: 32),

            // 안내 문구 (회원가입 버튼 없음!)
            Text(
              '병원에서 등록한 환자만 로그인할 수 있습니다.\n'
              '등록되지 않은 경우 병원 접수처에 문의하세요.',
              textAlign: TextAlign.center,
              style: TextStyle(color: Colors.grey, fontSize: 12),
            ),
          ],
        ),
      ),
    );
  }
}
```

#### 비밀번호 변경 강제 화면

```dart
// lib/features/auth/change_password_screen.dart

class ChangePasswordScreen extends StatefulWidget {
  final bool forceChange;

  const ChangePasswordScreen({Key? key, this.forceChange = false})
      : super(key: key);

  @override
  _ChangePasswordScreenState createState() => _ChangePasswordScreenState();
}

class _ChangePasswordScreenState extends State<ChangePasswordScreen> {
  final _newPasswordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  final _authRepo = AuthRepository();

  Future<void> _changePassword() async {
    if (_newPasswordController.text != _confirmPasswordController.text) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('비밀번호가 일치하지 않습니다')),
      );
      return;
    }

    try {
      await _authRepo.changePassword(_newPasswordController.text);

      if (widget.forceChange) {
        // 최초 로그인 플래그 해제
        await _authRepo.updateFirstLoginFlag(false);
      }

      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (context) => PatientMainPage()),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('비밀번호 변경 실패: $e')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      // 강제 변경 모드에서는 뒤로가기 차단
      onWillPop: () async => !widget.forceChange,
      child: Scaffold(
        appBar: AppBar(
          title: Text('비밀번호 변경'),
          automaticallyImplyLeading: !widget.forceChange,
        ),
        body: Padding(
          padding: EdgeInsets.all(24),
          child: Column(
            children: [
              if (widget.forceChange) ...[
                Icon(Icons.security, size: 64, color: Colors.orange),
                SizedBox(height: 16),
                Text(
                  '보안을 위해 비밀번호를 변경해주세요',
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                ),
                SizedBox(height: 8),
                Text(
                  '초기 비밀번호는 보안에 취약합니다.\n'
                  '안전한 비밀번호로 변경해주세요.',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: Colors.grey),
                ),
                SizedBox(height: 32),
              ],

              TextField(
                controller: _newPasswordController,
                decoration: InputDecoration(
                  labelText: '새 비밀번호',
                  hintText: '8자 이상, 영문+숫자+특수문자',
                ),
                obscureText: true,
              ),
              SizedBox(height: 16),

              TextField(
                controller: _confirmPasswordController,
                decoration: InputDecoration(
                  labelText: '비밀번호 확인',
                ),
                obscureText: true,
              ),
              SizedBox(height: 24),

              ElevatedButton(
                onPressed: _changePassword,
                style: ElevatedButton.styleFrom(
                  minimumSize: Size(double.infinity, 50),
                ),
                child: Text('변경 완료'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

---

## 4. API 명세

### 4.1 간호사 - 환자 등록

```
POST /api/v1/nurses/register-patient/
Authorization: Bearer <nurse-token>

Request:
{
  "first_name": "길동",
  "last_name": "홍",
  "ssn": "900101-1234567",
  "phone": "010-1234-5678",
  "address": "서울시 강남구...",
  "date_of_birth": "1990-01-01",
  "gender": "M",
  "doctor_id": 5,
  "emergency_contact": "010-9876-5432",
  "notes": "초진 환자"
}

Response (201):
{
  "message": "환자가 성공적으로 등록되었습니다.",
  "patient_id": 123,
  "pid": "PT-20251206-0123",
  "medical_record_number": "MR-20251206-0001",
  "phone": "01012345678",
  "initial_password": "testpass123",
  "sms_sent": true
}
```

### 4.2 환자 - 일반 로그인

```
POST /api/v1/users/login/

Request:
{
  "username": "01012345678",
  "password": "testpass123"
}

Response (200):
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 123,
    "username": "01012345678",
    "name": "홍길동",
    "is_first_login": true
  }
}
```

### 4.3 환자 - SMS 인증 로그인

```
POST /api/v1/users/sms-login/

Request:
{
  "phone": "010-1234-5678",
  "verification_code": "123456"
}

Response (200):
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 123,
    "username": "01012345678",
    "name": "홍길동",
    "is_first_login": true
  }
}
```

### 4.4 환자 - 비밀번호 변경

```
POST /api/v1/users/change-password/
Authorization: Bearer <patient-token>

Request:
{
  "new_password": "MySecureP@ss123",
  "new_password_confirm": "MySecureP@ss123"
}

Response (200):
{
  "message": "비밀번호가 성공적으로 변경되었습니다.",
  "is_first_login": false
}
```

---

## 5. 보안 고려사항

### 5.1 주민등록번호 암호화

```python
# apps/emr/models.py

from cryptography.fernet import Fernet
from django.conf import settings

class Patient(BaseModel):
    # 기존 필드들...

    encrypted_ssn = models.BinaryField(
        verbose_name="암호화된 주민등록번호",
        null=True,
        blank=True
    )

    def set_ssn(self, ssn):
        """주민등록번호 암호화하여 저장."""
        cipher_suite = Fernet(settings.SSN_ENCRYPTION_KEY.encode())
        encrypted = cipher_suite.encrypt(ssn.encode())
        self.encrypted_ssn = encrypted

    def get_ssn(self):
        """주민등록번호 복호화하여 반환."""
        if not self.encrypted_ssn:
            return None
        cipher_suite = Fernet(settings.SSN_ENCRYPTION_KEY.encode())
        decrypted = cipher_suite.decrypt(self.encrypted_ssn)
        return decrypted.decode()
```

### 5.2 초기 비밀번호 정책

- ✅ **기본값**: `testpass123` (기억하기 쉬움)
- ✅ **최초 로그인 시 변경 강제**: `is_first_login` 플래그 사용
- ✅ **SMS로 안내**: 환자에게 초기 비밀번호 전달
- ❌ **재사용 금지**: 초기 비밀번호로 변경 불가능

### 5.3 SMS 인증 보안

- ✅ **인증 코드**: 6자리 랜덤 숫자
- ✅ **유효 시간**: 3분
- ✅ **재전송 제한**: 1분에 1회
- ✅ **최대 시도 횟수**: 5회 실패 시 10분 차단

---

## 6. 데이터베이스 마이그레이션

### 6.1 UserProfile 모델에 is_first_login 필드 추가

```python
# apps/users/models.py

class UserProfile(BaseModel):
    # 기존 필드들...

    is_first_login = models.BooleanField(
        default=False,
        verbose_name="최초 로그인 여부",
        help_text="True이면 비밀번호 변경 필요"
    )
```

### 6.2 Patient 모델에 encrypted_ssn 필드 추가

```python
# apps/emr/models.py

class Patient(BaseModel):
    # 기존 필드들...

    encrypted_ssn = models.BinaryField(
        verbose_name="암호화된 주민등록번호",
        null=True,
        blank=True
    )
```

### 6.3 마이그레이션 실행

```bash
python manage.py makemigrations
python manage.py migrate
```

---

**문서 버전**: 1.0
**작성일**: 2025-12-06
**작성자**: NeuroNova Development Team
