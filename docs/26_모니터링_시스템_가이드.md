# NeuroNova 모니터링 시스템 가이드

## 목차
1. [개요](#개요)
2. [헬스 체크 시스템](#헬스-체크-시스템)
3. [로깅 시스템](#로깅-시스템)
4. [알림 설정](#알림-설정)
5. [시스템 통계 모니터링](#시스템-통계-모니터링)
6. [트러블슈팅](#트러블슈팅)

---

## 개요

NeuroNova 모니터링 시스템은 서비스의 건강 상태를 실시간으로 점검하고, 장애 발생 시 즉시 알림을 전송합니다.

### 주요 기능
- 자동 헬스 체크 (5분마다)
- 서비스 상태 모니터링 (Nginx, Django, Flask)
- 리소스 사용량 추적 (CPU, 메모리, 디스크)
- 장애 알림 (이메일, Slack)
- 로그 자동 관리 (30일 보관)

---

## 헬스 체크 시스템

### 설치

```bash
cd ~/NeuroNova/deploy/monitoring
sudo bash setup_monitoring.sh
```

스크립트가 자동으로 다음 작업을 수행합니다:
1. 로그 디렉토리 생성
2. 헬스 체크 스크립트 설치
3. Cron 작업 등록 (5분마다)
4. 로그 로테이션 설정

### 수동 실행

```bash
# 헬스 체크 실행
sudo neuronova-health-check

# 또는
cd ~/NeuroNova/deploy/monitoring
sudo bash health_check.sh
```

### 점검 항목

#### 1. Nginx 상태
```bash
# 상태 확인
systemctl status nginx

# 로그 확인
tail -f /var/log/nginx/error.log
```

#### 2. Django (Gunicorn) 상태
```bash
# 상태 확인
systemctl status gunicorn_django

# 로그 확인
sudo journalctl -u gunicorn_django -f

# API 응답 테스트
curl http://127.0.0.1:8000/api/health/
```

**응답 예시:**
```json
{
  "status": "healthy",
  "service": "NeuroNova Django API",
  "version": "1.0.0",
  "checks": {
    "database": "ok",
    "ml_server": "ok",
    "disk": "ok: 45.2% free",
    "media_storage": "ok"
  }
}
```

#### 3. Flask ML 서버 상태
```bash
# 상태 확인
systemctl status gunicorn_flask

# 로그 확인
sudo journalctl -u gunicorn_flask -f

# API 응답 테스트
curl http://127.0.0.1:9000/health
```

**응답 예시:**
```json
{
  "ok": true,
  "status": "alive",
  "model_version": "1.0.0"
}
```

#### 4. 디스크 사용량
```bash
# 디스크 사용량 확인
df -h

# 경고 기준
# - 80% 이상: WARNING
# - 90% 이상: CRITICAL
```

#### 5. 메모리 사용량
```bash
# 메모리 사용량 확인
free -h

# 경고 기준
# - 80% 이상: WARNING
# - 90% 이상: CRITICAL
```

#### 6. CPU 로드
```bash
# CPU 로드 확인
uptime

# 경고 기준
# - 70% 이상: WARNING
# - 90% 이상: CRITICAL
```

### 헬스 체크 결과

헬스 체크 결과는 `/var/log/neuronova/health_check.log`에 기록됩니다.

```bash
# 실시간 로그 확인
tail -f /var/log/neuronova/health_check.log

# 최근 50줄 확인
tail -50 /var/log/neuronova/health_check.log

# 에러만 필터링
grep ERROR /var/log/neuronova/health_check.log
```

**로그 예시:**
```
[2025-12-06 14:35:01] INFO: =========================================
[2025-12-06 14:35:01] INFO: NeuroNova 헬스 체크 시작
[2025-12-06 14:35:01] INFO: =========================================
[2025-12-06 14:35:01] INFO: 1. Nginx 상태 확인 중...
[2025-12-06 14:35:01] SUCCESS: Nginx: 정상 실행 중
[2025-12-06 14:35:01] INFO: 2. Django 상태 확인 중...
[2025-12-06 14:35:01] SUCCESS: Django: 정상 실행 중
[2025-12-06 14:35:02] SUCCESS: Django API: 응답 정상 (HTTP 200)
[2025-12-06 14:35:02] INFO: 3. Flask ML 서버 상태 확인 중...
[2025-12-06 14:35:02] SUCCESS: Flask: 정상 실행 중
[2025-12-06 14:35:02] SUCCESS: Flask API: 응답 정상 (HTTP 200)
[2025-12-06 14:35:02] INFO: 4. 디스크 사용량 확인 중...
[2025-12-06 14:35:02] SUCCESS: 디스크 사용량: 45% (정상)
[2025-12-06 14:35:02] INFO: 5. 메모리 사용량 확인 중...
[2025-12-06 14:35:02] SUCCESS: 메모리 사용량: 62% (정상)
[2025-12-06 14:35:02] INFO: 6. CPU 로드 확인 중...
[2025-12-06 14:35:02] SUCCESS: CPU 로드: 0.45 (28% of 4 cores)
[2025-12-06 14:35:02] INFO: =========================================
[2025-12-06 14:35:02] INFO: 헬스 체크 완료: OK
[2025-12-06 14:35:02] INFO: =========================================
```

---

## 로깅 시스템

### 로그 위치

| 서비스 | 로그 위치 | 설명 |
|--------|----------|------|
| Nginx | `/var/log/nginx/error.log` | Nginx 에러 로그 |
| Nginx | `/var/log/nginx/access.log` | 접근 로그 |
| Django | `journalctl -u gunicorn_django` | Django 애플리케이션 로그 |
| Flask | `journalctl -u gunicorn_flask` | Flask ML 서버 로그 |
| 헬스 체크 | `/var/log/neuronova/health_check.log` | 헬스 체크 결과 |
| Cron | `/var/log/neuronova/cron.log` | Cron 작업 실행 로그 |

### 로그 확인 방법

#### Nginx 로그
```bash
# 에러 로그 실시간 확인
sudo tail -f /var/log/nginx/error.log

# 접근 로그 실시간 확인
sudo tail -f /var/log/nginx/access.log

# 특정 IP 필터링
grep "192.168.1.100" /var/log/nginx/access.log

# 500 에러만 필터링
grep "HTTP/1.1\" 500" /var/log/nginx/access.log
```

#### Django 로그
```bash
# 실시간 로그
sudo journalctl -u gunicorn_django -f

# 최근 100줄
sudo journalctl -u gunicorn_django -n 100

# 오늘 로그만
sudo journalctl -u gunicorn_django --since today

# 에러만 필터링
sudo journalctl -u gunicorn_django | grep ERROR
```

#### Flask 로그
```bash
# 실시간 로그
sudo journalctl -u gunicorn_flask -f

# 최근 100줄
sudo journalctl -u gunicorn_flask -n 100

# ML 추론 로그만
sudo journalctl -u gunicorn_flask | grep "predict"
```

### 로그 로테이션

로그는 자동으로 로테이션됩니다:
- **보관 기간**: 30일
- **압축**: 1일 지난 로그 자동 압축
- **설정 파일**: `/etc/logrotate.d/neuronova`

수동으로 로테이션 실행:
```bash
sudo logrotate -f /etc/logrotate.d/neuronova
```

---

## 알림 설정

### 이메일 알림 설정

#### 1. mailutils 설치
```bash
sudo apt-get install -y mailutils
```

#### 2. 알림 이메일 주소 설정
```bash
sudo nano /usr/local/bin/neuronova-health-check
```

다음 라인 수정:
```bash
ALERT_EMAIL="your-email@example.com"
```

#### 3. 테스트
```bash
echo "테스트 메시지" | mail -s "NeuroNova 테스트" your-email@example.com
```

### Slack 알림 설정

#### 1. Slack Webhook URL 생성
1. Slack 워크스페이스 로그인
2. Apps → Incoming Webhooks 검색
3. "Add to Slack" 클릭
4. 채널 선택 (예: #alerts)
5. Webhook URL 복사

#### 2. Webhook URL 설정
```bash
sudo nano /usr/local/bin/neuronova-health-check
```

다음 라인 수정:
```bash
SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
```

#### 3. 테스트
```bash
curl -X POST -H 'Content-type: application/json' \
  --data '{"text":"NeuroNova 테스트 알림"}' \
  https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### 알림 발생 조건

알림은 다음 상황에서 발생합니다:

| 상태 | 조건 | 알림 |
|------|------|------|
| OK | 모든 서비스 정상 | 없음 |
| WARNING | 리소스 사용량 80-90% | 없음 (로그만) |
| CRITICAL | 서비스 중지 또는 리소스 90% 이상 | 이메일 + Slack |

**CRITICAL 알림 예시:**
```
[CRITICAL] NeuroNova 서비스 장애 발생!
실패한 서비스: Django Flask
시각: 2025-12-06 14:35:01
```

---

## 시스템 통계 모니터링

### API 엔드포인트

Django는 시스템 통계 API를 제공합니다 (관리자 전용):

```bash
# 시스템 통계 조회
curl http://your-domain.com/api/system/stats/
```

**응답 예시:**
```json
{
  "cpu": {
    "percent": 28.5,
    "count": 4,
    "load_avg": [0.45, 0.52, 0.48]
  },
  "memory": {
    "total": 8589934592,
    "available": 3221225472,
    "percent": 62.5
  },
  "disk": {
    "total": 107374182400,
    "used": 48318382080,
    "free": 59055800320,
    "percent": 45.0
  }
}
```

### React 관리자 대시보드 (선택사항)

시스템 통계를 실시간으로 확인할 수 있는 대시보드를 추가할 수 있습니다.

**구현 예시:**
```jsx
// SystemStatsCard.jsx
import React, { useState, useEffect } from 'react';

function SystemStatsCard() {
  const [stats, setStats] = useState(null);

  useEffect(() => {
    const fetchStats = async () => {
      const response = await fetch('/api/system/stats/');
      const data = await response.json();
      setStats(data);
    };

    fetchStats();
    const interval = setInterval(fetchStats, 30000); // 30초마다
    return () => clearInterval(interval);
  }, []);

  if (!stats) return <div>Loading...</div>;

  return (
    <div>
      <h3>시스템 통계</h3>
      <p>CPU: {stats.cpu.percent}%</p>
      <p>메모리: {stats.memory.percent}%</p>
      <p>디스크: {stats.disk.percent}%</p>
    </div>
  );
}
```

---

## 트러블슈팅

### 1. 헬스 체크 스크립트가 실행되지 않음

**증상:**
```bash
sudo neuronova-health-check
# bash: neuronova-health-check: command not found
```

**해결:**
```bash
# 스크립트 재설치
cd ~/NeuroNova/deploy/monitoring
sudo bash setup_monitoring.sh
```

### 2. Cron 작업이 실행되지 않음

**확인:**
```bash
# Cron 작업 목록 확인
crontab -l

# Cron 로그 확인
tail -f /var/log/neuronova/cron.log
```

**해결:**
```bash
# Cron 작업 재등록
cd ~/NeuroNova/deploy/monitoring
sudo bash setup_monitoring.sh
```

### 3. 이메일 알림이 오지 않음

**확인:**
```bash
# mailutils 설치 확인
dpkg -l | grep mailutils

# 테스트 메일 전송
echo "테스트" | mail -s "테스트" your-email@example.com
```

**해결:**
```bash
# mailutils 재설치
sudo apt-get install -y mailutils

# 이메일 주소 확인
sudo nano /usr/local/bin/neuronova-health-check
```

### 4. Slack 알림이 오지 않음

**확인:**
```bash
# Webhook URL 테스트
curl -X POST -H 'Content-type: application/json' \
  --data '{"text":"테스트"}' \
  YOUR_WEBHOOK_URL
```

**해결:**
- Webhook URL이 올바른지 확인
- Slack 채널이 활성화되어 있는지 확인

### 5. 로그 파일이 너무 큼

**확인:**
```bash
# 로그 파일 크기 확인
du -h /var/log/neuronova/health_check.log
```

**해결:**
```bash
# 로그 로테이션 즉시 실행
sudo logrotate -f /etc/logrotate.d/neuronova

# 또는 수동으로 정리
sudo truncate -s 0 /var/log/neuronova/health_check.log
```

### 6. 서비스가 자주 중단됨

**확인:**
```bash
# 서비스 재시작 횟수 확인
systemctl status gunicorn_django
systemctl status gunicorn_flask

# 최근 장애 로그 확인
sudo journalctl -u gunicorn_django --since "1 hour ago" | grep error
```

**해결:**
- 리소스 부족: 서버 스펙 업그레이드
- 메모리 누수: 애플리케이션 최적화
- 설정 오류: Gunicorn 타임아웃 설정 조정

---

## 추가 모니터링 도구 (선택사항)

### Prometheus + Grafana

고급 모니터링 및 시각화:
```bash
# Prometheus 설치
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
tar xvfz prometheus-*.tar.gz
cd prometheus-*
./prometheus --config.file=prometheus.yml

# Grafana 설치
sudo apt-get install -y adduser libfontconfig1
wget https://dl.grafana.com/oss/release/grafana_9.3.0_amd64.deb
sudo dpkg -i grafana_9.3.0_amd64.deb
sudo systemctl start grafana-server
```

### Sentry (에러 추적)

실시간 에러 추적 및 알림:
```bash
# Django settings.py에 추가
import sentry_sdk

sentry_sdk.init(
    dsn="YOUR_SENTRY_DSN",
    traces_sample_rate=1.0,
)
```

---

## 모니터링 체크리스트

정기적으로 다음 항목을 확인하세요:

**일일 체크:**
- [ ] 서비스 상태 확인 (`systemctl status`)
- [ ] 에러 로그 확인 (`tail -f /var/log/nginx/error.log`)
- [ ] 디스크 사용량 확인 (`df -h`)

**주간 체크:**
- [ ] 헬스 체크 로그 검토 (`/var/log/neuronova/health_check.log`)
- [ ] 리소스 사용 트렌드 확인
- [ ] 알림 시스템 테스트

**월간 체크:**
- [ ] 로그 로테이션 확인
- [ ] 백업 시스템 점검
- [ ] 보안 업데이트 적용

---

**문서 버전**: 1.0
**최종 수정일**: 2025-12-06
**작성자**: NeuroNova 개발팀
