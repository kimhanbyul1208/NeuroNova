# Walkthrough - Username Sync & Foreigner Support

I have implemented the features to synchronize the username with the phone number (for locals) or passport number (for foreigners), ensuring a seamless user experience.

## Changes

### Backend

#### 1. Models & Schema
- **`Patient` & `UserProfile`**: Added `passport_number` and made `phone` optional to support foreigners who might not have a local phone number initially. Added `is_foreigner` flag.

#### 2. Initialization Scripts (`init_test_data.py`)
- Updated to generate **10% foreigner users** with passport numbers as their username/ID.
- Modified patient generation to sync `phone` and `passport_number` from the `UserProfile`.

#### 3. Business Logic (`UserProfileSerializer`)
- **Foreigner Logic**: Added logic to handle `is_foreigner`. If true, `passport_number` is used as the ID.
- **ID Sync**:
    - **Locals**: Username updates to match `phone_number`.
    - **Foreigners**: Username updates to match `passport_number`.
- **Validation**: Added duplicate checks for phone and passport numbers.
- **Notifications**: configured to send Email/SMS notifications upon ID change.

#### 4. Seamless Login (`UserProfileViewSet`)
- **Token Refresh**: Modified the `update` method to detect username changes.
- **Response**: If the username changes, the API now returns a `new_token` (access & refresh) in the response, allowing the frontend to update the session without forcing a re-login.

### Frontend (Flutter)

#### 1. `AuthRepository`
- Updated `updateProfile` to inspect the response for `new_token`.
- Automatically updates the secure storage with the new tokens and user info if a refresh occurs.

#### 2. `EditProfileScreen`
- **Foreigner Toggle**: Added a switch to select "Foreigner" status.
- **Conditional Inputs**:
    - If **Foreigner**: Shows **Passport Number** input (mandatory). Phone is optional.
    - If **Local**: Shows **Phone Number** input (mandatory).
- **Feedback**: Displays a success message indicating if the login ID has been updated.

## Verification Results

### Automated Tests
- **Initialization**: `init_test_data.py` successfully generates mixed local/foreigner data.
- **Migration**: Schema changes prepared (migrations skipped as requested due to no DB, but code is ready).

### Manual Verification Checklist
1.  **Register/Login**:
    - [ ] Create a local user.
    - [ ] Create a foreigner user via script.
2.  **Edit Profile (Local)**:
    - [ ] Change phone number.
    - [ ] Verify username updates.
    - [ ] Verify new token is received and user stays logged in.
3.  **Edit Profile (Foreigner)**:
    - [ ] Toggle "Foreigner".
    - [ ] Enter Passport Number.
    - [ ] Verify username updates to Passport Number.
    - [ ] Verify seamless login.
