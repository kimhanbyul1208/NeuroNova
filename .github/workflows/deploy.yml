# NeuroNova ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# main ë¸Œëœì¹˜ì— pushí•˜ë©´ ìë™ìœ¼ë¡œ ì„œë²„ì— ë°°í¬ë¨

name: í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ë°°í¬ ì‹œì‘ ì•Œë¦¼
        run: echo "ğŸš€ NeuroNova ë°°í¬ ì‹œì‘..."

      - name: ì„œë²„ ë°°í¬
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "===== 1. ì½”ë“œ ì—…ë°ì´íŠ¸ ====="
            cd /var/www/neuronova
            git pull origin main

            echo "===== 2. ë°±ì—”ë“œ ì—…ë°ì´íŠ¸ ====="
            cd backend/django_main

            # ê°€ìƒí™˜ê²½ í™œì„±í™”
            source venv/bin/activate

            # Python ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
            pip install -r requirements.txt

            # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
            python manage.py migrate --noinput

            # ì •ì  íŒŒì¼ ìˆ˜ì§‘
            python manage.py collectstatic --noinput

            echo "===== 3. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ====="
            cd ../../frontend/react_web

            # Node ëª¨ë“ˆ ì„¤ì¹˜
            npm install

            # React ë¹Œë“œ
            npm run build

            echo "===== 4. ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ====="
            # Django (Gunicorn) ì¬ì‹œì‘
            sudo systemctl restart gunicorn_django

            # Nginx ì¬ë¡œë“œ
            sudo systemctl reload nginx

            echo "===== 5. ìƒíƒœ í™•ì¸ ====="
            # ì„œë¹„ìŠ¤ ìƒíƒœ ì²´í¬
            if sudo systemctl is-active --quiet gunicorn_django; then
              echo "âœ… Django ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘"
            else
              echo "âŒ Django ì„œë¹„ìŠ¤ ì‹¤íŒ¨"
              exit 1
            fi

            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… Nginx ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘"
            else
              echo "âŒ Nginx ì„œë¹„ìŠ¤ ì‹¤íŒ¨"
              exit 1
            fi

            echo "===== ë°°í¬ ì™„ë£Œ! ====="

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
